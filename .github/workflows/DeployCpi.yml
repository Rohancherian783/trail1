# Line 1
name: Deploy CPI Package from Git to Tenant 
# Line 2: MUST be the 'on' keyword, flush left
on:
  # Line 3: Indent by two spaces
  workflow_dispatch:
    inputs:
      package_id:
        description: "Enter the Package ID to deploy (must exist in Git)"
        required: true
 
jobs:
  deploy:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Deploy package artifacts using FlashPipe (FIXED)
        env:
          PKG: ${{ github.event.inputs.package_id }}
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          PACKAGE_DIR="cpi-artifacts/$PKG"
          
          # 1. Validation and Artifact ID finding remains the same
          if [ ! -d "$PACKAGE_DIR" ]; then
            echo "::error::Package directory $PACKAGE_DIR not found in the repository. Please sync it first."
            exit 1
          fi
          
          ARTIFACT_IDS=$(find "$PACKAGE_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f,")
          ARTIFACT_IDS=${ARTIFACT_IDS%,}
          
          if [ -z "$ARTIFACT_IDS" ]; then
            echo "::warning::No artifacts found in $PACKAGE_DIR. Nothing to deploy."
            exit 0
          fi
          
          echo "Deploying Artifact IDs: $ARTIFACT_IDS from package $PKG"
          
          # 2. Run FlashPipe commands inside Docker
          docker run --rm \
            --user $(id -u):$(id -g) \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            -e PKG="$PKG" \
            -e ARTIFACT_IDS="$ARTIFACT_IDS" \
            -e TMN_HOST="$TMN_HOST" \
            -e OAUTH_HOST="$OAUTH_HOST" \
            -e CLIENT_ID="$CLIENT_ID" \
            -e CLIENT_SECRET="$CLIENT_SECRET" \
            engswee/flashpipe:latest \
            sh -c '
              echo "➡ Step 1: Ensuring package $PKG exists on tenant..."
              
              # Run flashpipe sync to ensure the package structure is created if missing.
              flashpipe sync \
                --tmn-host "$TMN_HOST" \
                --oauth-host "$OAUTH_HOST" \
                --oauth-clientid "$CLIENT_ID" \
                --oauth-clientsecret "$CLIENT_SECRET" \
                --package-id "$PKG" \
                --dir-artifacts "cpi-artifacts/$PKG" \
                --sync-package-details
                
              echo "➡ Step 2: Deploying artifacts ($ARTIFACT_IDS)..."
              
              # Now run the deploy command, which should succeed since the package exists.
              flashpipe deploy \
                --tmn-host "$TMN_HOST" \
                --oauth-host "$OAUTH_HOST" \
                --oauth-clientid "$CLIENT_ID" \
                --oauth-clientsecret "$CLIENT_SECRET" \
                --artifact-ids "$ARTIFACT_IDS" \
                --artifact-type "Integration" 
            '
