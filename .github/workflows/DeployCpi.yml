jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: engswee/flashpipe:latest

    steps:
      # ... checkout step ...

      #####################################################
      # PACKAGE: CPIPracticeflows
      #####################################################
      - name: 'Deploy CPIPracticeflows (Metadata Update & Artifact Deployment)'
        if: ${{ github.event.inputs.package == 'CPIPracticeflows' }}
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          PKG="CPIPracticeflows"
          
          # 1. Ensure Package Structure Exists (Import/Update Metadata)
          echo "➡ Step 1: Updating package metadata..."
          flashpipe import-package \
            --tmn-host "$TMN_HOST" \
            --oauth-host "$OAUTH_HOST" \
            --oauth-clientid "$CLIENT_ID" \
            --oauth-clientsecret "$CLIENT_SECRET" \
            --package-id "$PKG" \
            --dir-artifacts "cpi-artifacts/$PKG"

          # 2. Deploy Artifacts (Find Artifact IDs first, if needed)
          echo "➡ Step 2: Deploying artifacts..."
          
          PACKAGE_DIR="cpi-artifacts/$PKG"
          ARTIFACT_IDS=$(find "$PACKAGE_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f,")
          ARTIFACT_IDS=${ARTIFACT_IDS%,}
          
          flashpipe deploy \
            --tmn-host "$TMN_HOST" \
            --oauth-host "$OAUTH_HOST" \
            --oauth-clientid "$CLIENT_ID" \
            --oauth-clientsecret "$CLIENT_SECRET" \
            --artifact-ids "$ARTIFACT_IDS" \
            --artifact-type "Integration"
