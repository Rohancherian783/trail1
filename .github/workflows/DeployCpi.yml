- name: Deploy package using FlashPipe (FIXED)
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          PKG="${{ github.event.inputs.package }}" # PKG is "logan"
          
          docker run --rm \
            --user $(id -u):$(id -g) \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            -e TMN_HOST="$TMN_HOST" \
            -e OAUTH_HOST="$OAUTH_HOST" \
            -e CLIENT_ID="$CLIENT_ID" \
            -e CLIENT_SECRET="$CLIENT_SECRET" \
            engswee/flashpipe:latest \
            sh -c '
              # Use the package directory to deploy ALL artifacts within it
              PACKAGE_DIR="cpi-artifacts/$PKG"
              
              if [ ! -d "$PACKAGE_DIR" ]; then
                echo "::error::Package directory $PACKAGE_DIR not found. Did you sync it first?"
                exit 1
              fi
              
              # Find all artifact directories (which are the artifact IDs)
              ARTIFACT_IDS=$(find "$PACKAGE_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f,")
              ARTIFACT_IDS=${ARTIFACT_IDS%,} # Remove trailing comma
              
              if [ -z "$ARTIFACT_IDS" ]; then
                echo "::error::No artifacts found in $PACKAGE_DIR."
                exit 1
              fi
              
              echo "Deploying artifacts: $ARTIFACT_IDS from package directory $PACKAGE_DIR"
              
              # Deploy command now targets specific artifacts using their IDs, 
              # which implicitly points to the package directory structure.
              # We must specify the directory separately using a config file or similar if needed.
              # Let's try to deploy just the integration flows first as a test.
              flashpipe deploy \
                --tmn-host "$TMN_HOST" \
                --oauth-host "$OAUTH_HOST" \
                --oauth-clientid "$CLIENT_ID" \
                --oauth-clientsecret "$CLIENT_SECRET" \
                --artifact-ids "$ARTIFACT_IDS" \
                --artifact-type "Integration" 
            '
