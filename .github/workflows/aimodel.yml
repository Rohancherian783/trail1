name: ðŸ¤– Generation Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          # Define the target blue color here
          HEADING_COLOR: "#1f4e79"
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # --- System Prompt ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure. CRITICALLY, you MUST ONLY use the required inline HTML tags for all headings (H1 and H2) to ensure the dark blue color ('${{ env.HEADING_COLOR }}') is applied. DO NOT use Markdown heading syntax (# or ##) for the main report body headings.
          
          **MANDATORY SECTIONS:**
          1. Table of Contents (with <br> after each item and '---TOC-END-PAGE-BREAK---' marker)
          2. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">1. Introduction</h1>
          3. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">2. Integration Overview</h1> (Include Mermaid 'graph TD' diagram)
          4. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">3. Integration Scenarios</h1>
          5. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">4. Error Handling and Logging</h1>
          6. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">5. Testing Validation</h1>
          7. <h1 style=\"color: ${{ env.HEADING_COLOR }};\">6. Reference Documents</h1>"

          ALL_DOCS_GENERATED=false

          # 1. Safely find all directories containing iFlow artifacts
          find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u | while IFS= read -r IFLOW_DIR; do
            
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            # If the path is deep (src/main/...), get the top-level folder name inside the package
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            
            # We want to save the summary in the root folder of that iFlow
            FINAL_IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_ROOT_NAME"
            OUTPUT_FILE="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Summary.md"
            
            echo "Processing iFlow: $IFLOW_ROOT_NAME"
            
            FULL_ARTIFACT_CONTENT=""
            
            # 2. Safely find all source files within this iFlow directory
            # Using -print0 and 'read -d' to handle spaces/special characters in filenames
            while IFS= read -r -d '' INPUT_FILE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done < <(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print0)

            if [ -z "$FULL_ARTIFACT_CONTENT" ]; then
                echo "  âš ï¸ No artifacts found for $IFLOW_ROOT_NAME. Skipping."
                continue
            fi

            USER_QUERY="Synthesize a single report for iFlow '$IFLOW_ROOT_NAME'. Artifacts:\n\n$FULL_ARTIFACT_CONTENT"

            # 3. Create JSON payload safely using jq
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}')

            # 4. API Call with Retries
            RETRY_COUNT=0
            while [ "$RETRY_COUNT" -lt 3 ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                # Clean code blocks
                GENERATED_TEXT_CLEANED=$(echo -e "$GENERATED_TEXT" | sed -E '1s/^\s*```(markdown|text)?//' | sed -E '$s/\s*```\s*$//')
                
                # Metadata for Cover Page
                AUTHOR=$(git log -1 --pretty=format:'%an')
                DATE=$(date +'%Y-%m-%d')
                VERSION=$(git rev-parse --short HEAD)
                CLEAN_IFLOW_NAME=$(echo "$IFLOW_ROOT_NAME" | sed 's/_/ /g')

                # Logos and Formatting
                SAP_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MM_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                
                LOGO_HEADER="<div style=\"float: left;\"><img src=\"$SAP_LOGO_URL\" width=\"150\" height=\"60\"/></div><div style=\"float: right;\"><img src=\"$MM_LOGO_URL\" width=\"150\" height=\"55\"/></div><div style=\"clear: both;\"></div>"
                
                COVER_PAGE="${LOGO_HEADER}<div style=\"height: 80px;\"></div><h1 style=\"color: ${{ env.HEADING_COLOR }}; text-align: center;\">$CLEAN_IFLOW_NAME</h1><h2 style=\"text-align: center;\">Technical Specification</h2>"
                COVER_PAGE+="<div style=\"height: 100px;\"></div><div style=\"text-align: center;\"><table border=\"1\" style=\"margin: 0 auto;\"><tr><td>Author</td><td>$AUTHOR</td></tr><tr><td>Date</td><td>$DATE</td></tr></table></div>"
                
                FINAL_DOC="${COVER_PAGE}<div style=\"page-break-after: always;\"></div>\n\n${LOGO_HEADER}\n${GENERATED_TEXT_CLEANED}"
                
                # Insert Page Break after TOC
                SECTION_BREAK="\n<div style=\"page-break-before: always;\"></div>\n${LOGO_HEADER}\n"
                FINAL_DOC=$(echo -e "$FINAL_DOC" | sed "s|---TOC-END-PAGE-BREAK---|$(echo "$SECTION_BREAK" | sed 's/[&/]/\\&/g')|g")

                echo -e "$FINAL_DOC" > "$OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 2
              fi
            done
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"
          if ! git diff --cached --quiet; then
              git commit -m "ðŸ¤– DOCS: Updated iFlow summaries for $PKG_ID"
              git push
          fi
