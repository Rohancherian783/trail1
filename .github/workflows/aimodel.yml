name: ðŸ¤– Generation Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            exit 1
          fi

          # --- SYSTEM PROMPT (Enforcing Boxed Table Structure) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze the provided artifacts and create a professional technical report.
          **CRITICAL FORMATTING INSTRUCTIONS:**
          1. **COLOR SCHEME:** All Headings (H1/H2) and Subheadings MUST use the color '${{ env.HEADING_COLOR }}'.
          2. **HEADINGS:** Use ONLY inline HTML for H1 and H2.
          3. **SUBHEADINGS:** Wrap labels in: <b style=\"color: ${{ env.HEADING_COLOR }};\">...</b> followed by a NEW LINE for content.
          4. **FORCE BOXED TABLES:** You MUST use standard Markdown table syntax (using pipes | and dashes ---) for all tabular data. Do NOT use plain text lists for tables.
          5. **TESTING VALIDATION:** In Section 5, analyze the project code (XML, Groovy, etc.) and generate 5-6 logical test cases unique to THIS iFlow.
             - Columns: | Test Case ID | Scenario | Expected Outcome |
             - Separator: | :--- | :--- | :--- |

          **REQUIRED STRUCTURE:**
          <h1 style=\"color: ${{ env.HEADING_COLOR }}; font-size: 2.5em;\">Table of Contents</h1>
          ...
          ---TOC-END-PAGE-BREAK---
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">1. Introduction</h1>
          ...
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">5. Testing Validation</h1>
          **Testing Details â€“ Sheet: Testing**
          (Generate the Markdown table here based on the artifact logic.)
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">6. Reference Documents</h1>"

          ALL_DOCS_GENERATED=false
          while IFS= read -r IFLOW_DIR; do
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            FINAL_IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_ROOT_NAME"
            OUTPUT_FILE="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Summary.md"
            
            EXTRACTED_VERSION=$(grep -rPho '(?<=<Version>)[^<]+' "$IFLOW_DIR" | head -n 1)
            IFLOW_VERSION=${EXTRACTED_VERSION:-"1.0.0"}

            QUERY_FILE="user_query.tmp"
            echo -e "Synthesize report for iFlow '$IFLOW_ROOT_NAME'. Analyze the logic to create project-specific test cases.\n\nSource Artifacts:\n" > "$QUERY_FILE"
            while IFS= read -r -d '' INPUT_FILE; do
              echo -e "\n--- ARTIFACT: $INPUT_FILE ---\n" >> "$QUERY_FILE"
              cat "$INPUT_FILE" >> "$QUERY_FILE"
            done < <(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print0)

            PAYLOAD_FILE="payload.json"
            jq -n --arg system "$SYSTEM_PROMPT" --rawfile query "$QUERY_FILE" --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}' > "$PAYLOAD_FILE"

            API_RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d @"$PAYLOAD_FILE")
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content // empty")
            
            if [ -n "$GENERATED_TEXT" ] && [ "$GENERATED_TEXT" != "null" ]; then
              GENERATED_TEXT_CLEANED=$(echo -e "$GENERATED_TEXT" | sed -E '1s/^\s*```(markdown|text)?//' | sed -E '$s/\s*```\s*$//')
              AUTHOR=$(git log -1 --pretty=format:'%an')
              DATE=$(date +'%Y-%m-%d')
              CLEAN_NAME=$(echo "$IFLOW_ROOT_NAME" | sed 's/_/ /g')
              SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
              MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
              LOGO_HEADER="<div style=\"width:100%; height: 100px;\"><div style=\"float: left;\"><img src=\"$SAP_LOGO\" width=\"200\" height=\"80\"/></div><div style=\"float: right;\"><img src=\"$MM_LOGO\" width=\"190\" height=\"70\"/></div><div style=\"clear: both;\"></div></div>"
              
              # --- GLOBAL STYLE: This ensures ALL tables are in boxes with black borders ---
              GLOBAL_STYLE="<style>table { width: 98% !important; border-collapse: collapse !important; border: 1px solid #000 !important; margin: 20px auto; } th, td { border: 1px solid #000 !important; padding: 12px !important; text-align: left; } th { background-color: #f2f2f2; }</style>"

              COVER_PAGE="${LOGO_HEADER}<div style=\"height: 100px;\"></div><h1 style=\"color: ${{ env.HEADING_COLOR }}; text-align: center; font-size: 3.5em;\">$CLEAN_NAME</h1>"
              COVER_PAGE+="<h2 style=\"text-align: center; font-size: 2em;\">Technical Specification Document</h2>"
              COVER_PAGE+="<div style=\"height: 100px;\"></div><div style=\"text-align: center;\">"
              COVER_PAGE+="<table>"
              COVER_PAGE+="<tr><th>Author</th><td>$AUTHOR</td></tr>"
              COVER_PAGE+="<tr><th>Date</th><td>$DATE</td></tr>"
              COVER_PAGE+="<tr><th>Version</th><td>$IFLOW_VERSION</td></tr>"
              COVER_PAGE+="</table></div>"

              FINAL_DOC="${GLOBAL_STYLE}${COVER_PAGE}<div style=\"page-break-after: always;\"></div>\n\n${LOGO_HEADER}\n${GENERATED_TEXT_CLEANED}"
              SECTION_BREAK="\n<div style=\"page-break-before: always;\"></div>\n${LOGO_HEADER}\n"
              FINAL_DOC=$(echo -e "$FINAL_DOC" | sed "s|---TOC-END-PAGE-BREAK---|$(echo "$SECTION_BREAK" | sed 's/[&/]/\\&/g')|g")
              
              echo -e "$FINAL_DOC" > "$OUTPUT_FILE"
              ALL_DOCS_GENERATED=true
            fi
            rm -f "$QUERY_FILE" "$PAYLOAD_FILE"
          done < <(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u)
          
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"
          git commit -m "ðŸ¤– DOCS: Fixed boxed tables and automated project-specific test cases for $PKG_ID"
          git push
