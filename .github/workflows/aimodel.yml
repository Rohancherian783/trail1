name: ðŸ¤– Generate Documentation for ALL Artifacts in ONE Package
 
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
 
      - name: Generate Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} 
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          PKG_DIR="cpi-artifacts/$PKG_ID"
          
          if [ ! -d "$PKG_DIR" ]; then
            echo "::error::Package directory not found at: $PKG_DIR"
            echo "::error::Please check if Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "ðŸ” Analyzing ALL content inside Package: $PKG_ID"
          
          # --- Prompt Definitions (Unchanged) ---
          IFLOW_SYSTEM_PROMPT="You are a professional SAP CPI Technical Writer. Analyze the iFlow XML and generate structured documentation following 11 mandatory sections: 1. High-level architecture, 2. Purpose, 3. Sender/Receiver, 4. Adapter types, 5. Step-by-step flow, 6. Mapping logic, 7. Groovy script explanations, 8. Error handling, 9. Security/authentication, 10. Deployment notes, 11. ASCII message flow diagram. Use Markdown."
          
          SCRIPT_SYSTEM_PROMPT="You are an expert CPI developer. Analyze the Groovy script code. Document the script in Markdown with sections for: 1. Purpose, 2. Input/Output Headers, 3. Code Summary and Logic, and 4. Recommendations/Best Practices."
          
          XSLT_SYSTEM_PROMPT="You are a data mapping expert. Analyze the XSLT code. Document the transformation in Markdown with sections for: 1. Purpose, 2. Source/Target Structure Notes, 3. Key Transformation Rules, and 4. Known Limitations."

          SUCCESS_COUNT=0
          
          # Find all potentially valuable files (iFlow XML, Groovy Scripts, XSLT)
          FILES_TO_ANALYZE=$(find "$PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \) -print)

          if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "::warning::No supported files (iFlowContent.xml, *.groovy, *.xslt) found in package '$PKG_ID'."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi

          # Loop through each file found
          for INPUT_FILE in $FILES_TO_ANALYZE; do
            FILE_NAME=$(basename "$INPUT_FILE")
            DIR_PATH=$(dirname "$INPUT_FILE")
            
            echo "--------------------------------------------------------"
            echo "  Processing File: $INPUT_FILE"

            # 1. Determine artifact type and set prompt/output file name
            case "$FILE_NAME" in
              iFlowContent.xml)
                ARTIFACT_NAME=$(basename "$DIR_PATH")
                OUTPUT_FILE="$DIR_PATH/Documentation_README.md"
                SYSTEM_PROMPT="$IFLOW_SYSTEM_PROMPT"
                USER_QUERY="Analyze the following SAP CPI iFlow XML content and generate the full 11-section documentation for it: \n\n\`\`\`xml\n$(cat "$INPUT_FILE")\n\`\`\`"
                ;;
              *.groovy)
                ARTIFACT_NAME="$FILE_NAME"
                OUTPUT_FILE="$DIR_PATH/${FILE_NAME}.md"
                SYSTEM_PROMPT="$SCRIPT_SYSTEM_PROMPT"
                USER_QUERY="Analyze the following Groovy script from CPI and generate technical documentation for it: \n\n\`\`\`groovy\n$(cat "$INPUT_FILE")\n\`\`\`"
                ;;
              *.xslt)
                ARTIFACT_NAME="$FILE_NAME"
                OUTPUT_FILE="$DIR_PATH/${FILE_NAME}.md"
                SYSTEM_PROMPT="$XSLT_SYSTEM_PROMPT"
                USER_QUERY="Analyze the following XSLT mapping from CPI and generate technical documentation for it: \n\n\`\`\`xml\n$(cat "$INPUT_FILE")\n\`\`\`"
                ;;
              *)
                echo "  Skipping unsupported file type: $FILE_NAME"
                continue
                ;;
            esac
            
            # --- API Call Logic ---
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  âœ… Documentation generated successfully."
                echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
                echo "  ðŸ’¾ Saved documentation to $OUTPUT_FILE"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                break
              else
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "  âš ï¸ API call failed for $ARTIFACT_NAME: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "  âŒ Failed to generate documentation after $MAX_RETRIES attempts for $ARTIFACT_NAME. Skipping to next artifact."
            fi

          done # End of FILE loop
          
          if [ $SUCCESS_COUNT -gt 0 ]; then
             echo "docs_generated=true" >> $GITHUB_OUTPUT
             echo "Total $SUCCESS_COUNT artifacts documented."
          else
             echo "docs_generated=false" >> $GITHUB_OUTPUT
             echo "No artifacts were successfully documented."
          fi
          
 
      - name: Commit Generated Documentation (Robust)
        # Only run this step if the previous step successfully generated at least one doc
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          PKG_ID="${{ github.event.inputs.package_id }}"

          # Use a broad, robust pattern to add ANY .md file created in the package hierarchy
          # The --force flag ensures 'git add' does not fail if it can't match every sub-pattern.
          git add --force "cpi-artifacts/$PKG_ID/**/*.md"
          
          # Check if any documentation files were modified/added
          if git diff --cached --quiet; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              # Use find command output to get a list of changed/new files for a precise commit
              # This ensures we commit all the generated documentation
              git commit -m "ðŸ¤– DOCS: Generated documentation for package: $PKG_ID (GPT-4o mini)."
              git push
              echo "âœ… Documentation committed and pushed to repository for package $PKG_ID."
          fi
