name: ðŸ¤– Generate Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        # FIX: Changed 'actions:checkout@v4' to 'actions/checkout@v4'
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # --- Prompt Definitions: STRICT HIERARCHICAL STRUCTURE (Updated) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical structure, starting with the Title Page, followed by the Table of Contents, and then the 6 main sections.

          **MANDATORY FIRST SECTION: TITLE PAGE (Matching Corporate Template)**
          The very first output of the document MUST be the Title Page, designed to simulate the corporate cover page (Page 1).

          1.  **Logos and Header:** Align the SAP logo to the left and the partner logo ('motivemnds') to the right on the same line. Use placehold.co links for visual placeholders.
              \`\`\`html
              <div style=\"width: 100%; overflow: hidden; margin-bottom: 20px;\">
                <div style=\"float: left;\">
                  <img src=\"https://placehold.co/150x50/00305e/ffffff?text=SAP\" alt=\"SAP Logo\" style=\"height: 40px;\">
                </div>
                <div style=\"float: right; border: 1px solid #924b95; padding: 5px;\">
                  <img src=\"https://placehold.co/150x50/924b95/ffffff?text=motivemnds\" alt=\"Company Logo\" style=\"height: 40px;\">
                </div>
              </div>
              <br><br><br>
              \`\`\`
          2.  **Document Title:** Center and style the main title based on the iFlow name provided in the user query (e.g., '[IFLOW NAME] Integration Technical Specification'). Use a prominent, dark blue color. Add significant vertical spacing before the title.
              \`\`\`html
              <h1 align=\"center\" style=\"color: #1f4e79; font-size: 3em; margin-top: 150px;\">[IFLOW_NAME] Integration Technical Specification</h1>
              <br><br><br>
              \`\`\`
          3.  **Metadata Table (Updated for Layout):** Create a robust HTML table that resembles the boxed, left-aligned table shown in the screenshot for key document metadata.
              \`\`\`html
              <div style=\"width: 400px; border: 1px solid black; padding: 0px; margin-left: 20px; margin-top: 100px;\">
                <table style=\"width: 100%; border-collapse: collapse; margin: 0;\">
                  <tr><td style=\"font-weight: bold; padding: 5px; border-right: 1px solid #ddd; width: 30%;\">Author</td><td style=\"padding: 5px;\">[Lead Developer Name]</td></tr>
                  <tr><td style=\"font-weight: bold; padding: 5px; border-top: 1px solid #ddd; border-right: 1px solid #ddd;\">Date</td><td style=\"padding: 5px; border-top: 1px solid #ddd;\">[Current Date, e.g., 2025-12-10]</td></tr>
                  <tr><td style=\"font-weight: bold; padding: 5px; border-top: 1px solid #ddd; border-right: 1px solid #ddd;\">Version</td><td style=\"padding: 5px; border-top: 1px solid #ddd;\">1.0 (Draft)</td></tr>
                </table>
              </div>
              \`\`\`
          4.  **Page Break Simulation:** Add a significant vertical space (20+ lines) to visually separate the title page content from the TOC.

          **MANDATORY SECOND SECTION: TABLE OF CONTENTS (TOC) (Updated for Indentation)**
          The TOC MUST appear immediately after the Title Page. Format the TOC heading using HTML to achieve a prominent blue color and large font, like this: \`<h2 style=\"color: #1f4e79; font-size: 2.5em;\">Table of Contents</h2>\`. Below this heading, list all 6 main sections and their subsections using **nested standard Markdown ordered lists**. The model should not use literal \`&nbsp;\` entities or hard-coded numbers (e.g., \`1.1\`, \`1.2\`) for indentation/numbering; instead, use standard nested list syntax (indentation with spaces/tabs) to achieve the hierarchical look. Use a generous number of blank lines (e.g., 10 lines) after the TOC list to create maximum visual separation before starting Section 1.

          **MANDATORY CORE SECTIONS (Following TOC):**

          # 1. Introduction
          ## 1.1 Purpose (Map: Purpose of this iFlow)
          ## 1.2 Scope (Describe the boundaries and systems affected by this single iFlow)

          # 2. Integration Overview
          ## 2.1 Integration Architecture (Map: High-level architecture + Process Diagram)
          (Output the High-Level Process Flow Diagram immediately after the architecture text using only Mermaid syntax within a \`\`\`mermaid code block. The diagram must be a 'graph TD' (Top-Down) flowchart showing the major systems and their high-level interaction points, NOT the low-level iFlow steps. **CRITICAL: Ensure there is one blank line immediately following the closing \`\`\` of the Mermaid block.**)
          ## 2.2 Integration Components (Map: Sender/Receiver systems + Adapter types used)

          # 3. Integration Scenarios
          ## 3.1 Scenario Description (Map: Step-by-step flow explanation detailing the iFlow path)
          ## 3.2 Data Flows (Map: Mapping logic summary (XSLT/Mappings) + Groovy script explanations (usage/purpose))
          ## 3.3 Security Requirements (Map: Security/authentication details on mechanisms, credentials, and configuration)

          # 4. Error Handling and Logging (Map: Error handling details)

          # 5. Testing Validation (Summarize key testing requirements/scenarios based on iFlow logic)

          # 6. Reference Documents (List the input artifacts analyzed: iFlowContent.xml, Groovy scripts, XSLT files, etc.)"
          
          # --- Main Logic: Find and Process Each iFlow Folder ---
          
          # Find all supported iFlow files (iFlowContent.xml or *.iflw) recursively.
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
          
          if [ -z "$FULL_IFLOW_PATHS" ]; then
              echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi
          
          # CRITICAL FIX: Extract the top-level iFlow artifact folder name (e.g., 'Task1')
          # 1. Strip the base package path ($BASE_PKG_DIR/) from the full path.
          # 2. Cut based on the first slash (/) to get the artifact name (e.g., 'Task1').
          # 3. Use 'sort -u' to get unique names.
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          
          # Reconstruct the full paths for the root directories to loop over
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false
          
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            # We try to determine the iFlow artifact name from the directory path
            IFLOW_NAME=$(basename "$IFLOW_DIR") 
            # ðŸ’¡ UPDATED: Use the actual iFlow name in the output filename
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
            
            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
            
            # 1. Data Consolidation (Searches recursively from the top-level iFlow folder)
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
            
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "  âš ï¸ No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
            
            # Loop through files and append content
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
            
            echo "  Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
            
            # CRITICAL: Pass the IFLOW_NAME into the user query so the model can insert it into the Title Page.
            USER_QUERY="Synthesize a single, consolidated technical report following the mandatory Title Page, Table of Contents, and 6 core hierarchical sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. You MUST use '$IFLOW_NAME' for the document title on the Title Page. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
            
            # 2. API Call Logic
            # Re-creating the PAYLOAD for each iFlow loop (important for scope separation)
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
            
            # NEW ERROR CHECK: Check if jq successfully generated the PAYLOAD
            JQ_EXIT_CODE=$?
            if [ $JQ_EXIT_CODE -ne 0 ]; then
                echo "::error::Failed to construct JSON payload using jq. Exit Code: $JQ_EXIT_CODE"
                echo "::error::This is often caused by invalid characters or excessively long content breaking the JSON structure."
                echo "docs_generated=false" >> $GITHUB_OUTPUT
                exit 1
            fi
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
                
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
              
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  âœ… Documentation generated successfully."
                echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
                echo "  ðŸ’¾ Saved documentation to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                break
              else
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "  âš ï¸ API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "  âŒ Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
          
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT
          
      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          PKG_ID="${{ github.event.inputs.package_id }}"
          # ðŸ’¡ UPDATED: Use a wildcard to capture all files ending in _Summary.md 
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/*_Summary.md" 
          
          git add "$OUTPUT_PATH"
          
          # Check if there are any changes (can be new files or modified files)
          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              git commit -m "ðŸ¤– DOCS: Generated/Updated individual iFlow summaries for package: $PKG_ID (GPT-4o mini)."
              git push
              echo "âœ… All iFlow documentation committed and pushed to repository."
          fi
