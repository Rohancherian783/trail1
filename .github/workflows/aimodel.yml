name: ðŸ¤– Generate Single Consolidated Documentation for Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Generate Consolidated Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          PKG_DIR="cpi-artifacts/$PKG_ID"
          OUTPUT_FILE="$PKG_DIR/Package_Summary.md" # The single output file
          
          if [ ! -d "$PKG_DIR" ]; then
            echo "::error::Package directory not found at: $PKG_DIR"
            echo "::error::Please check if Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "ðŸ” Consolidating ALL CPI artifacts into a single request for Package: $PKG_ID"
          
          # --- Prompt Definitions: STRICT 10-Point Structure (UPDATED) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from a single CPI package and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure. Consolidate Groovy, XSLT, and iFlow logic into the relevant sections (5, 6, and 7).
          
          The 10 mandatory sections, using Markdown headings, are:
          1. High-level architecture
          2. Purpose of each iFlow
          3. Sender/Receiver systems (Consolidated)
          4. Adapter types used (Consolidated)
          5. Step-by-step flow explanation (For each iFlow)
          6. Mapping logic summary (Summarize XSLT, Mappings)
          7. Groovy script explanations (Summarize all scripts and their usage/purpose)
          8. Error handling
          9. Security/authentication (Provide detailed explanation of mechanisms, credentials, and configuration)
          10. High-Level Process Flow Diagram (Output this as a simple flowchart or sequence diagram using Markdown/Mermaid syntax, detailing the main integration steps.)" # Point 10 updated
          
          # --- Data Consolidation ---
          FULL_ARTIFACT_CONTENT=""
          
          # Find all supported files (iFlow XML, Groovy Scripts, XSLT)
          FILES_TO_ANALYZE=$(find "$PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \) -print)
          
          if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "::warning::No supported artifacts found in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi
          
          # Loop through files and append content, clearly labeled, to the FULL_ARTIFACT_CONTENT variable
          for INPUT_FILE in $FILES_TO_ANALYZE; do
            FILE_CONTENT=$(cat "$INPUT_FILE")
            
            # Use distinct markers for the AI to easily separate and identify artifacts
            FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
            FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
            FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
          done
          
          echo "Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
          
          USER_QUERY="Synthesize a single, consolidated technical report following the 10 mandatory sections from the entire set of package artifacts provided below. Use the file names (e.g., iFlowContent.xml, Script.groovy) to structure your analysis. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
          
          # --- API Call Logic ---
          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg query "$USER_QUERY" \
            --arg model "$MODEL_NAME" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $query}
              ],
              temperature: 0.1
            }')
            
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            API_RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "$PAYLOAD")
              
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
            
            if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
              echo "  âœ… Consolidated Documentation generated successfully."
              echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
              echo "  ðŸ’¾ Saved consolidated documentation to $OUTPUT_FILE"
              echo "docs_generated=true" >> $GITHUB_OUTPUT
              break
            else
              ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
              RETRY_COUNT=$((RETRY_COUNT + 1))
              DELAY=$((2**RETRY_COUNT))
              echo "  âš ï¸ API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
              sleep "$DELAY"
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "  âŒ Failed to generate consolidated documentation after $MAX_RETRIES attempts."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit Consolidated Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          PKG_ID="${{ github.event.inputs.package_id }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/Package_Summary.md"
          
          git add "$OUTPUT_PATH"
          
          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No meaningful changes detected in the generated documentation file. Skipping commit."
          else
              git commit -m "ðŸ¤– DOCS: Consolidated Package Summary generated for package: $PKG_ID (GPT-4o mini)."
              git push
              echo "âœ… Documentation committed and pushed to repository."
          fi
