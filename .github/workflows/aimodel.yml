name: ðŸ¤– Generation Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            exit 1
          fi

          # --- UPDATED SYSTEM PROMPT WITH YOUR TOC ---
          [cite_start]SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated technical report. You MUST adhere strictly to the following 6-point structure[cite: 75]:
          
          CRITICALLY: 
          1. Use ONLY inline HTML for headings (H1 and H2) in color '${{ env.HEADING_COLOR }}'. 
          2. For Section 2.1, you MUST use a Mermaid 'graph TD' block. 
          3. IMPORTANT: Every Mermaid line MUST be on a new line. Do not put the entire diagram on one line.
          
          [cite_start]**MANDATORY FIRST SECTION: TABLE OF CONTENTS (TOC) PAGE** [cite: 75]
          1. [cite_start]Introduction [cite: 76]
          2. [cite_start]Integration Overview [cite: 79]
          3. [cite_start]Integration Scenarios [cite: 82]
          4. [cite_start]Error Handling and Logging [cite: 86]
          5. [cite_start]Testing Validation [cite: 87]
          6. [cite_start]Reference Documents [cite: 88]
          
          Use <br> for line spacing and end with marker '---TOC-END-PAGE-BREAK---'.

          **REQUIRED SECTIONS:**
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">1. [cite_start]Introduction</h1> [cite: 76]
          [cite_start]1.1 Purpose [cite: 77][cite_start], 1.2 Scope[cite: 78].
          
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">2. [cite_start]Integration Overview</h1> [cite: 79]
          [cite_start]2.1 Integration Architecture (Use Mermaid 'graph TD' block here)[cite: 80].
          [cite_start]2.2 Integration Components (Sender/Receiver systems + Adapters)[cite: 81, 108].
          
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">3. [cite_start]Integration Scenarios</h1> [cite: 82]
          [cite_start]3.1 Scenario Description [cite: 83][cite_start], 3.2 Data Flows [cite: 84, 116][cite_start], 3.3 Security Requirements[cite: 85, 119].
          
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">4. [cite_start]Error Handling and Logging</h1>[cite: 86, 124].
          
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">5. [cite_start]Testing Validation</h1>[cite: 87, 138].
          
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">6. [cite_start]Reference Documents</h1>[cite: 88]."

          ALL_DOCS_GENERATED=false

          while IFS= read -r IFLOW_DIR; do
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            FINAL_IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_ROOT_NAME"
            OUTPUT_FILE="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Summary.md"
            
            echo "ðŸš€ Processing iFlow: $IFLOW_ROOT_NAME"
            
            QUERY_FILE="user_query.tmp"
            echo -e "Synthesize a report for '$IFLOW_ROOT_NAME'. Artifacts:\n" > "$QUERY_FILE"
            while IFS= read -r -d '' INPUT_FILE; do
              echo -e "\n\n--- START: $INPUT_FILE ---\n" >> "$QUERY_FILE"
              cat "$INPUT_FILE" >> "$QUERY_FILE"
              echo -e "\n--- END: $INPUT_FILE ---\n" >> "$QUERY_FILE"
            done < <(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print0)

            PAYLOAD_FILE="payload.json"
            jq -n --arg system "$SYSTEM_PROMPT" --rawfile query "$QUERY_FILE" --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}' > "$PAYLOAD_FILE"

            RETRY_COUNT=0
            while [ "$RETRY_COUNT" -lt 3 ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d @"$PAYLOAD_FILE")
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content // empty")

              if [ -n "$GENERATED_TEXT" ] && [ "$GENERATED_TEXT" != "null" ]; then
                # --- FIX: New cleaning logic that preserves internal Markdown newlines for Mermaid ---
                GENERATED_TEXT_CLEANED=$(echo "$GENERATED_TEXT" | sed '1{/^```/d}; ${/^```/d}')
                
                AUTHOR=$(git log -1 --pretty=format:'%an')
                DATE=$(date +'%Y-%m-%d')
                CLEAN_NAME=$(echo "$IFLOW_ROOT_NAME" | sed 's/_/ /g')
                SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                LOGO_HEADER="<div style=\"float: left;\"><img src=\"$SAP_LOGO\" width=\"150\" height=\"60\"/></div><div style=\"float: right;\"><img src=\"$MM_LOGO\" width=\"150\" height=\"55\"/></div><div style=\"clear: both;\"></div>"
                
                COVER_PAGE="${LOGO_HEADER}<div style=\"height: 80px;\"></div><h1 style=\"color: ${{ env.HEADING_COLOR }}; text-align: center; font-size: 3em;\">$CLEAN_NAME</h1>"
                COVER_PAGE+="<h2 style=\"text-align: center;\">Technical Specification Document</h2>"
                COVER_PAGE+="<div style=\"height: 100px;\"></div><div style=\"text-align: center;\"><table border=\"1\" style=\"margin: 0 auto; border-collapse: collapse;\">"
                COVER_PAGE+="<tr><td style=\"padding: 10px;\"><b>Author</b></td><td style=\"padding: 10px;\">$AUTHOR</td></tr>"
                COVER_PAGE+="<tr><td style=\"padding: 10px;\"><b>Date</b></td><td style=\"padding: 10px;\">$DATE</td></tr>"
                COVER_PAGE+="</table></div>"
                
                FINAL_DOC="${COVER_PAGE}<div style=\"page-break-after: always;\"></div>\n\n${LOGO_HEADER}\n${GENERATED_TEXT_CLEANED}"
                SECTION_BREAK="\n<div style=\"page-break-before: always;\"></div>\n${LOGO_HEADER}\n"
                FINAL_DOC=$(echo -e "$FINAL_DOC" | sed "s|---TOC-END-PAGE-BREAK---|$(echo "$SECTION_BREAK" | sed 's/[&/]/\\&/g')|g")

                echo -e "$FINAL_DOC" > "$OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                echo "âœ… Documentation generated for $IFLOW_ROOT_NAME"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 5
              fi
            done
            rm -f "$QUERY_FILE" "$PAYLOAD_FILE"
          done < <(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u)

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"
          if ! git diff --cached --quiet; then
              git commit -m "ðŸ¤– DOCS: Fixed mermaid rendering for $PKG_ID"
              git push
          fi
