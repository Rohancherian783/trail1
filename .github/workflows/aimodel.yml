name: ü§ñ Generate CPI Documentation for Specific iFlow
 
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'TEST_PACKAGE')."
        required: true
        type: string
      iflow_name:
        description: "The name of the iFlow folder within the package (e.g., 'REST_to_SOAP_iFlow')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq and base64)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq base64
 
      - name: Generate Documentation via OpenAI API
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} 
          PKG_ID: ${{ github.event.inputs.package_id }}
          IFLOW_ID: ${{ github.event.inputs.iflow_name }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          IFLOW_PATH="cpi-artifacts/$PKG_ID/$IFLOW_ID"
          INPUT_FILE="$IFLOW_PATH/iFlowContent.xml"
          OUTPUT_FILE="$IFLOW_PATH/Documentation_README.md"
          
          if [ ! -f "$INPUT_FILE" ]; then
            echo "::error::iFlow XML file not found at: $INPUT_FILE"
            echo "::error::Please check if Package ID ('$PKG_ID') and iFlow Name ('$IFLOW_ID') are correct and exist in your repository."
            exit 1
          fi

          echo "üîç Analyzing iFlow: $IFLOW_ID inside Package: $PKG_ID"
          
          # --- Detailed System Prompt for 11-Point Structure ---
          # This forces the model to adhere to your specific requirements.
          SYSTEM_PROMPT="You are a professional SAP CPI Technical Writer. Your sole task is to analyze the provided integration flow (iFlow) XML content and generate a comprehensive, structured technical documentation. The output MUST strictly follow the 11-point structure listed in the user query, using Markdown headings (e.g., '## 1. High-Level Architecture').
          
          The 11 mandatory sections are:
          1. High-level architecture
          2. Purpose of each iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary
          7. Groovy script explanations
          8. Error handling
          9. Security/authentication
          10. Deployment notes
          11. ASCII message flow diagram (Use Markdown code blocks for the diagram)."
          
          # --- API Call Logic ---
          XML_CONTENT=$(cat "$INPUT_FILE")
          USER_QUERY="Analyze the following SAP CPI iFlow XML content and generate the full 11-section documentation for it: \n\n\`\`\`xml\n$XML_CONTENT\n\`\`\`"
          
          # Construct the JSON payload for OpenAI
          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg query "$USER_QUERY" \
            --arg model "$MODEL_NAME" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $query}
              ],
              temperature: 0.1
            }')
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            API_RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "$PAYLOAD")

            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

            if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
              echo "  ‚úÖ Documentation generated successfully."
              
              # Save the generated Markdown content
              echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
              echo "  üíæ Saved documentation to $OUTPUT_FILE"
              break
            else
              ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
              RETRY_COUNT=$((RETRY_COUNT + 1))
              DELAY=$((2**RETRY_COUNT))
              echo "  ‚ö†Ô∏è API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
              sleep "$DELAY"
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "  ‚ùå Failed to generate documentation after $MAX_RETRIES attempts for $IFLOW_ID."
            exit 1
          fi
 
      - name: Commit Generated Documentation
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Use the environment variables set earlier
          PKG_ID="${{ github.event.inputs.package_id }}"
          IFLOW_ID="${{ github.event.inputs.iflow_name }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/$IFLOW_ID/Documentation_README.md"
          
          git add "$OUTPUT_PATH"
          
          # Check if the specific documentation file was modified/added
          if git diff --cached --quiet -- "$OUTPUT_PATH"; then
              echo "No changes detected in the generated documentation file. Skipping commit."
          else
              git commit -m "ü§ñ DOCS: Generated documentation for iFlow: $IFLOW_ID (GPT-4o mini)."
              git push
              echo "‚úÖ Documentation committed and pushed to repository for $IFLOW_ID."
          fi
