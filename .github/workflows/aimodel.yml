name: ðŸ¤– Generate Individual iFlow Documentation
 
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string
 
jobs:
  document:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        # FIX: Changed 'actions:checkout@v4' to 'actions/checkout@v4'
        uses: actions/checkout@v4
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          # --- Prompt Definitions: STRICT 10-Point Structure (Updated) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure. Consolidate Groovy, XSLT, and iFlow logic into the relevant sections (5, 6, and 7).
          The 10 mandatory sections, using Markdown headings, are:
          1. High-level architecture
          2. Purpose of this iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary (Summarize XSLT, Mappings)
          7. Groovy script explanations (Summarize all scripts and their usage/purpose)
          8. Error handling
          9. Security/authentication (Provide detailed explanation of mechanisms, credentials, and configuration)
          10. High-Level Process Flow Diagram (Output this using only Mermaid syntax within a \`\`\`mermaid code block. The diagram must be a 'graph TD' (Top-Down) sequence diagram that focuses on the end-to-end integration, showing the major systems involved (e.g., Sender System, CPI, Receiver System) and their interaction points, NOT the low-level iFlow steps like 'Content Modifier' or 'Splitter'. **CRITICAL: Ensure there is one blank line immediately following the closing \`\`\` of the Mermaid block.**)"
          # --- Main Logic: Find and Process Each iFlow Folder ---
          # Find all supported iFlow files (iFlowContent.xml or *.iflw) recursively.
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
          if [ -z "$FULL_IFLOW_PATHS" ]; then
              echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi
          # CRITICAL FIX: Extract the top-level iFlow artifact folder name (e.g., 'Task1')
          # 1. Strip the base package path ($BASE_PKG_DIR/) from the full path.
          # 2. Cut based on the first slash (/) to get the artifact name (e.g., 'Task1').
          # 3. Use 'sort -u' to get unique names.
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          # Reconstruct the full paths for the root directories to loop over
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          ALL_DOCS_GENERATED=false
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            # We try to determine the iFlow artifact name from the directory path
            IFLOW_NAME=$(basename "$IFLOW_DIR") 
            OUTPUT_FILE="$IFLOW_DIR/iFlow_Summary.md"
            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
            # 1. Data Consolidation (Searches recursively from the top-level iFlow folder)
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "  âš ï¸ No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
            # Loop through files and append content
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
            echo "  Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
            USER_QUERY="Synthesize a single, consolidated technical report following the 10 mandatory sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
            # 2. API Call Logic
            # Re-creating the PAYLOAD for each iFlow loop (important for scope separation)
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  âœ… Documentation generated successfully."
                echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
                echo "  ðŸ’¾ Saved documentation to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                break
              else
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "  âš ï¸ API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "  âŒ Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT
      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          # Use a broad path to capture all iFlow_Summary.md files
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/iFlow_Summary.md" 
          git add "$OUTPUT_PATH"
          # Check if there are any changes (can be new files or modified files)
          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              git commit -m "ðŸ¤– DOCS: Generated/Updated individual iFlow summaries for package: $PKG_ID (GPT-4o mini)."
              git push
              echo "âœ… All iFlow documentation committed and pushed to repository."
          fi
