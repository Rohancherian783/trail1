name: Sync All Configured CPI Packages
 
on:
  workflow_dispatch:
    # No inputs needed - it reads from packages.txt
 
jobs:
  sync:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
 
      - name: Read and normalize package list
        id: normalize
        run: |
          # The script requires a packages.txt file with one package ID per line
          if [ ! -f packages.txt ]; then
            echo "::error file=packages.txt::packages.txt not found. Cannot proceed."
            exit 1
          fi
          # Read the file and replace newlines with spaces for shell iteration
          PACKAGES=$(tr '\n' ' ' < packages.txt)
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Packages to sync: $PACKAGES"
 
      - name: Run FlashPipe inside Docker
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          docker run --rm \
            --user $(id -u):$(id -g) \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            -e TMN_HOST="$TMN_HOST" \
            -e OAUTH_HOST="$OAUTH_HOST" \
            -e CLIENT_ID="$CLIENT_ID" \
            -e CLIENT_SECRET="$CLIENT_SECRET" \
            engswee/flashpipe:latest \
            sh -c '
              # Loop over the space-separated list of packages from the "normalize" step
              for PKG in ${{ steps.normalize.outputs.packages }}; do
                echo "âž¡ Syncing $PKG..."
                # The sync command handles authentication internally
                flashpipe sync \
                  --tmn-host "$TMN_HOST" \
                  --oauth-host "$OAUTH_HOST" \
                  --oauth-clientid "$CLIENT_ID" \
                  --oauth-clientsecret "$CLIENT_SECRET" \
                  --package-id "$PKG" \
                  --dir-artifacts "cpi-artifacts/$PKG" \
                  --sync-package-details
              done
            '
 
      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Automated CPI package sync (configured list)" || echo "No changes"
          git push || true

















