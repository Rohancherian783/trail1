name: ðŸ¤– test Documentation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string
jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit the generated documentation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
                    
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
                    
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
                    
          # --- Prompt Definitions: STRICT HIERARCHICAL STRUCTURE (Unchanged) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure, using Markdown headings (# for main sections, ## for subsections). Ensure all technical details (like Groovy, XSLT, Adapters, Security) are thoroughly explained within the relevant sections.
          **MANDATORY FIRST SECTION: TABLE OF CONTENTS (TOC) PAGE**
          The very first output of the document MUST be the Table of Contents. Format the TOC heading using HTML to achieve a prominent blue color and large font, like this: \`<h1 style=\"color: #1f4e79; font-size: 2.5em;\">Table of Contents</h1>\`. Below this heading, list all 6 main sections and their subsections using standard Markdown numbered list syntax (e.g., 1., 1.1., 1.2., etc.), ensuring proper indentation and **avoiding the use of HTML entities like &nbsp; for spacing**. Use a generous number of blank lines (e.g., 10 lines) after the TOC list to create maximum visual separation before starting Section 1.
          The mandatory sections and their required content mapping are:
          # 1. Introduction
          ## 1.1 Purpose (Map: Purpose of this iFlow)
          ## 1.2 Scope (Describe the boundaries and systems affected by this single iFlow)
          # 2. Integration Overview
          ## 2.1 Integration Architecture (Map: High-level architecture + Process Diagram)
          (Output the High-Level Process Flow Diagram immediately after the architecture text using only Mermaid syntax within a \`\`\`mermaid code block. The diagram must be a 'graph TD' (Top-Down) flowchart showing the major systems and their high-level interaction points, NOT the low-level iFlow steps. **CRITICAL: Ensure there is one blank line immediately following the closing \`\`\` of the Mermaid block.**)
          ## 2.2 Integration Components (Map: Sender/Receiver systems + Adapter types used)
          # 3. Integration Scenarios
          ## 3.1 Scenario Description (Map: Step-by-step flow explanation detailing the iFlow path)
          ## 3.2 Data Flows (Map: Mapping logic summary (XSLT/Mappings) + Groovy script explanations (usage/purpose))
          ## 3.3 Security Requirements (Map: Security/authentication details on mechanisms, credentials, and configuration)
          # 4. Error Handling and Logging (Map: Error handling details)
          # 5. Testing Validation (Summarize key testing requirements/scenarios based on iFlow logic)
          # 6. Reference Documents (List the input artifacts analyzed: iFlowContent.xml, Groovy scripts, XSLT files, etc.)"
                    
          # --- Main Logic: Find and Process Each iFlow Folder ---
                    
          # Find all supported iFlow files (iFlowContent.xml or *.iflw) recursively.
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
                    
          if [ -z "$FULL_IFLOW_PATHS" ]; then
              echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi
                    
          # CRITICAL FIX: Extract the top-level iFlow artifact folder name (e.g., 'Task1')
          # 1. Strip the base package path ($BASE_PKG_DIR/) from the full path.
          # 2. Cut based on the first slash (/) to get the artifact name (e.g., 'Task1').
          # 3. Use 'sort -u' to get unique names.
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
                    
          # Reconstruct the full paths for the root directories to loop over
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          ALL_DOCS_GENERATED=false
                    
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            # We try to determine the iFlow artifact name from the directory path
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            # ðŸ’¡ UPDATED: Use the actual iFlow name in the output filename
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
                        
            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
                        
            # 1. Data Consolidation (Searches recursively from the top-level iFlow folder)
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
                        
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "  âš ï¸ No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
                        
            # Loop through files and append content
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              # Use actual newlines here instead of \n for cleaner separation in the prompt input
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
                        
            echo "  Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
                        
            USER_QUERY="Synthesize a single, consolidated technical report following the 6 mandatory hierarchical sections and all sub-sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
                        
            # 2. API Call Logic
            # Re-creating the PAYLOAD for each iFlow loop (important for scope separation)
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
                          
            # NEW ERROR CHECK: Check if jq successfully generated the PAYLOAD
            JQ_EXIT_CODE=$?
            if [ $JQ_EXIT_CODE -ne 0 ]; then
                echo "::error::Failed to construct JSON payload using jq. Exit Code: $JQ_EXIT_CODE"
                echo "::error::This is often caused by invalid characters or excessively long content breaking the JSON structure."
                echo "docs_generated=false" >> $GITHUB_OUTPUT
                exit 1
            fi
                        
            MAX_RETRIES=3
            RETRY_COUNT=0
                        
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
                              
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
                            
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  âœ… Documentation generated successfully."
                # --- START COVER PAGE GENERATION LOGIC (FIXED) ---
                                
                # Static/Default Variables for the Cover Page
                AUTHOR="Nidhi Srivastava"
                DATE="2025-12-01"
                VERSION="Draft"
                                
                # Use sed to replace underscores with spaces for a cleaner title
                CLEAN_IFLOW_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')
                PROJECT_TITLE="AI Tech Specification Project - Odata Mass PDF upload"
                                
                # --- LOGO SETUP (Using confirmed URLs) ---
                SAP_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MOTIVEMINDS_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                # --- END LOGO SETUP ---

                # 1. Top Logo Placement: SAP on Left, Motiveminds on Right
                SAP_LOGO_BLOCK="<div style=\"float: left; text-align: left;\"><img src=\"$SAP_LOGO_URL\" alt=\"SAP Logo\" width=\"100\" height=\"40\"/></div>"
                MOTIVEMINDS_LOGO_BLOCK="<div style=\"float: right; text-align: right;\"><img src=\"$MOTIVEMINDS_LOGO_URL\" alt=\"motiveminds Logo\" width=\"80\" height=\"30\" style=\"margin-top: 5px;\"/></div>"

                # Combine the logo blocks and clear the float. 
                # Use actual newlines in the script here (no \n)
                COVER_PAGE_CONTENT="${SAP_LOGO_BLOCK}${MOTIVEMINDS_LOGO_BLOCK}<div style=\"clear: both;\"></div>\n\n\n\n\n\n\n"
                                
                # 2. Project Title and iFlow Name, styled to match the image
                FULL_TITLE="$PROJECT_TITLE - $CLEAN_IFLOW_NAME"
                
                # FIX 1: Remove the redundant plain text variable insertion
                COVER_PAGE_CONTENT+="<h1 style=\"color: #1f4e79; font-size: 3em; text-align: left; margin-top: 100px;\">$FULL_TITLE</h1>"
                
                # Add newlines after the title (no \n)
                COVER_PAGE_CONTENT+="\n\n\n\n\n\n"
                                
                # 3. Metadata block - Using EXPLICIT HTML TABLE for guaranteed box rendering
                # Add newlines before the table (no \n)
                COVER_PAGE_CONTENT+="\n\n\n\n\n\n\n" 
                
                # HTML Table content (no \n)
                COVER_PAGE_CONTENT+="<table border=\"1\" style=\"width: 400px; border-collapse: collapse; border-color: black;\">\n"
                COVER_PAGE_CONTENT+="  <tr><td style=\"width: 30%; padding: 5px;\">**Author:**</td><td style=\"padding: 5px;\">$AUTHOR</td></tr>\n"
                COVER_PAGE_CONTENT+="  <tr><td style=\"padding: 5px;\">**Date:**</td><td style=\"padding: 5px;\">$DATE</td></tr>\n"
                COVER_PAGE_CONTENT+="  <tr><td style=\"padding: 5px;\">**Version:**</td><td style=\"padding: 5px;\">$VERSION</td></tr>\n"
                COVER_PAGE_CONTENT+="</table>"
                                
                # 4. Add enough newlines for visual separation before the TOC (23 newlines)
                COVER_PAGE_CONTENT+="\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
                                
                # Combine the Cover Page and the AI-generated Content
                FULL_DOCUMENTATION="${COVER_PAGE_CONTENT}${GENERATED_TEXT}"
                                
                # FIX 2: Use echo -e to interpret the \n sequences as actual newlines
                echo -e "$FULL_DOCUMENTATION" > "$OUTPUT_FILE"
                echo "  ðŸ’¾ Saved documentation with cover page to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                # --- END COVER PAGE GENERATION LOGIC ---
                                
                break
              else
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "  âš ï¸ API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
                        
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "  âŒ Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
                    
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT
      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
                    
          PKG_ID="${{ github.event.inputs.package_id }}"
          # ðŸ’¡ UPDATED: Use a wildcard to capture all files ending in _Summary.md
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/*_Summary.md"
                    
          git add "$OUTPUT_PATH"
                    
          # Check if there are any changes (can be new files or modified files)
          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              git commit -m "ðŸ¤– DOCS: Generated/Updated individual iFlow summaries for package: $PKG_ID (GPT-4o mini)."
              git push
              echo "âœ… All iFlow documentation committed and pushed to repository."
          fi
