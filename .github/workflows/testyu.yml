name: ü§ñ CPI Documentation Generation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit the generated documentation and PDFs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # --- Step 1: Generate Individual iFlow Documentation (Unchanged) ---
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
                      
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
                      
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
                      
          # --- Prompt Definitions: STRICT HIERARCHICAL STRUCTURE (FINAL COLOR/MERMAID FIX) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure. CRITICALLY, you MUST ONLY use the required inline HTML tags for all headings (H1 and H2) to ensure the dark blue color (#1f4e79) is applied. DO NOT use Markdown heading syntax (# or ##) for the main report body. Ensure all technical details (like Groovy, XSLT, Adapters, Security) are thoroughly explained within the relevant sections.

          **MANDATORY FIRST SECTION: TABLE OF CONTENTS (TOC) PAGE**
          The very first output of the document MUST be the Table of Contents. Format the TOC heading using HTML to achieve a prominent blue color and large font, like this: <h1 style=\"color: #1f4e79; font-size: 2.5em;\">Table of Contents</h1>. Below this heading, list all 6 main sections and their subsections using standard Markdown numbered list syntax (e.g., 1., 1.1., 1.2., etc.), ensuring proper indentation and **avoiding the use of HTML entities like &nbsp; for spacing**. Use a generous number of blank lines (e.g., 10 lines) after the TOC list to create maximum visual separation, then **add the unique marker '---TOC-END-PAGE-BREAK---' on its own line before starting Section 1.**

          The mandatory sections, **which MUST be generated using the styled HTML headings only**, are:
          <h1 style=\"color: #1f4e79;\">1. Introduction</h1>
          <h2 style=\"color: #1f4e79;\">1.1 Purpose</h2> (Map: Purpose of this iFlow)
          <h2 style=\"color: #1f4e79;\">1.2 Scope</h2> (Describe the boundaries and systems affected by this single iFlow)
          <h1 style=\"color: #1f4e79;\">2. Integration Overview</h1>
          <h2 style=\"color: #1f4e79;\">2.1 Integration Architecture</h2> (Map: High-level architecture + Process Diagram)
          (Output the High-Level Process Flow Diagram immediately after the architecture text using only Mermaid syntax. The diagram **MUST START on a new line immediately following the architecture text** with \`\`\`mermaid, contain only pure graph definitions (e.g., 'graph TD', nodes, and arrows), and **MUST BE followed by one blank line immediately after the closing \`\`\`**. The diagram must be a 'graph TD' (Top-Down) flowchart showing the major systems and their high-level interaction points, NOT the low-level iFlow steps.)
          <h2 style=\"color: #1f4e79;\">2.2 Integration Components</h2> (Map: Sender/Receiver systems + Adapter types used)
          <h1 style=\"color: #1f4e79;\">3. Integration Scenarios</h1>
          <h2 style=\"color: #1f4e79;\">3.1 Scenario Description</h2> (Map: Step-by-step flow explanation detailing the iFlow path)
          <h2 style=\"color: #1f4e79;\">3.2 Data Flows</h2> (Map: Mapping logic summary (XSLT/Mappings) + Groovy script explanations (usage/purpose))
          <h2 style=\"color: #1f4e79;\">3.3 Security Requirements</h2> (Map: Security/authentication details on mechanisms, credentials, and configuration)
          <h1 style=\"color: #1f4e79;\">4. Error Handling and Logging</h1> (Map: Error handling details)
          <h1 style=\"color: #1f4e79;\">5. Testing Validation</h1> (Summarize key testing requirements/scenarios based on iFlow logic)
          <h1 style=\"color: #1f4e79;\">6. Reference Documents</h1> (List the input artifacts analyzed: iFlowContent.xml, Groovy scripts, XSLT files, etc.)"
                      
          # --- Main Logic: Find and Process Each iFlow Folder ---
                      
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
                      
          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
                      
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          ALL_DOCS_GENERATED=false
                      
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
                          
            echo "=================================================="
            echo "‚û° Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
                          
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
                          
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "¬† ‚ö†Ô∏è No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
                          
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
                          
            echo "¬† Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
                          
            USER_QUERY="Synthesize a single, consolidated technical report following the 6 mandatory hierarchical sections and all sub-sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
                          
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
                              
            JQ_EXIT_CODE=$?
            if [ "$JQ_EXIT_CODE" -ne 0 ]; then
                echo "::error::Failed to construct JSON payload using jq. Exit Code: $JQ_EXIT_CODE"
                echo "docs_generated=false" >> $GITHUB_OUTPUT
                exit 1
            fi
                          
            MAX_RETRIES=3
            RETRY_COUNT=0
                          
            while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
                                  
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
                              
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "¬† ‚úÖ Documentation generated successfully."
                # --- START COVER PAGE GENERATION LOGIC ---
                                      
                # DYNAMIC METADATA COLLECTION
                AUTHOR=$(git log -1 --pretty=format:'%an')
                DATE=$(date +'%Y-%m-%d')
                VERSION=$(git rev-parse --short HEAD)
                                      
                CLEAN_IFLOW_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')
                                      
                # --- LOGO SETUP ---
                SAP_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MOTIVEMINDS_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                # --- END LOGO SETUP ---

                # 1. Top Logo Placement: SAP on Left, Motiveminds on Right (Cover Page only)
                SAP_LOGO_BLOCK="<div style=\"float: left; text-align: left;\"><img src=\"$SAP_LOGO_URL\" alt=\"SAP Logo\" width=\"150\" height=\"60\"/></div>"
                MOTIVEMINDS_LOGO_BLOCK="<div style=\"float: right; text-align: right;\"><img src=\"$MOTIVEMINDS_LOGO_URL\" alt=\"motiveminds Logo\" width=\"150\" height=\"55\" style=\"margin-top: 5px;\"/></div>"

                # Combine the logo blocks and clear the float.¬†
                COVER_PAGE_CONTENT="${SAP_LOGO_BLOCK}${MOTIVEMINDS_LOGO_BLOCK}<div style=\"clear: both;\"></div>"
                
                # Add initial vertical space for centering the titles
                COVER_PAGE_CONTENT+="<div style=\"height: 80px;\"></div>"
                                      
                # 2. Main Title (iFlow Name) and Subheading (Technical Specification Document)
                
                # Main Title (iFlow Name only) - MUST BE FIRST & CENTERED
                COVER_PAGE_CONTENT+="<h1 style=\"color: #1f4e79; font-size: 3em; text-align: center; margin-top: 5px; margin-bottom: 5px;\">$CLEAN_IFLOW_NAME</h1>"
                
                # Subheading added second & CENTERED
                COVER_PAGE_CONTENT+="<h2 style=\"color: #1f4e79; font-size: 1.5em; text-align: center; margin-top: 5px; margin-bottom: 0px;\">SAP CPI Technical Specification Document</h2>"
                
                # Add significant vertical space after the title block
                COVER_PAGE_CONTENT+="<div style=\"height: 100px;\"></div>"
                                      
                # 3. Metadata block - CENTERED
                COVER_PAGE_CONTENT+="<div style=\"width: 100%; text-align: center;\">\n"
                
                # HTML Table content (uses dynamic variables) - centered via margin: 0 auto;
                COVER_PAGE_CONTENT+="<table border=\"1\" style=\"width: 400px; border-collapse: collapse; border-color: black; margin: 0 auto; text-align: left;\">\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"width: 30%; padding: 5px;\">**Author:**</td><td style=\"padding: 5px;\">$AUTHOR</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Date:**</td><td style=\"padding: 5px;\">$DATE</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Version (Commit):**</td><td style=\"padding: 5px;\">$VERSION</td></tr>\n"
                COVER_PAGE_CONTENT+="</table>\n"
                COVER_PAGE_CONTENT+="</div>\n" # Close the centering div
                                      
                # CRITICAL: PAGE BREAK AFTER COVER PAGE (Page 1 -> Page 2)
                COVER_PAGE_CONTENT+="\n<div style=\"page-break-after: always;\"></div>\n\n"
                                      
                # 4. Combine Cover Page and AI-generated Content
                FULL_DOCUMENTATION="${COVER_PAGE_CONTENT}${GENERATED_TEXT}"
                                      
                PAGE_BREAK_AFTER_TOC="\n<div style=\"page-break-after: always;\"></div>\n"
                
                # FIX: Use the unique marker to insert the page break reliably (TOC Page 2 -> Intro Page 3)
                TOC_CLEANED_DOCUMENTATION=$(echo -e "$FULL_DOCUMENTATION" | sed -E "s|---TOC-END-PAGE-BREAK---|$PAGE_BREAK_AFTER_TOC|g")
                                      
                # Use the cleaned document for output
                echo -e "$TOC_CLEANED_DOCUMENTATION" > "$OUTPUT_FILE"

                echo "¬† üíæ Saved documentation with cover page and page breaks to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                # --- END COVER PAGE GENERATION LOGIC ---
                                      
                break
              else
                # API failure/retry logic
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "¬† ‚ö†Ô∏è API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
                          
            if [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; then
              echo "¬† ‚ùå Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
                      
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      # --- START DEFINITIVE PDF GENERATION STEPS (Pandoc/LaTeX) ---

      - name: üìù Convert Markdown to HTML for Pandoc Processing
        if: steps.documentation_step.outputs.docs_generated == 'true'
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          SAP_LOGO_URL: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
          MOTIVEMINDS_LOGO_URL: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
          
        run: |
          IFLOW_ROOT_NAMES=$(find "cpi-artifacts/$PKG_ID" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print | sed "s|^cpi-artifacts/$PKG_ID/||" | cut -d/ -f1 | sort -u)
          
          # HTML template for the repeating header/footer
          # We define a basic HTML template for Pandoc to insert, including CSS for the repeating header
          
          CSS_STYLE="
          <style>
            body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
            .header-content { 
              display: flex; 
              justify-content: space-between; 
              align-items: center; 
              width: 100%;
              border-bottom: 1px solid #1f4e79; 
              padding: 5px 0;
            }
            .page-header {
              position: running(header);
              padding-top: 10px;
              padding-bottom: 10px;
            }
            @page {
              margin-top: 1.2in; /* Make space for header */
              margin-bottom: 0.8in;
              margin-left: 0.5in;
              margin-right: 0.5in;
              @top { content: element(header); }
            }
          </style>
          "
          REPEATING_HEADER="
          <div class='page-header' style='height: 1in; width: 100%;'>
            <div class='header-content'>
              <img src='${{ env.SAP_LOGO_URL }}' alt='SAP Logo' style='height: 30px;'/>
              <span style='font-size: 10px; color: #1f4e79; font-weight: bold;'>SAP CPI Technical Specification</span>
              <img src='${{ env.MOTIVEMINDS_LOGO_URL }}' alt='motiveminds Logo' style='height: 25px;'/>
            </div>
          </div>
          "
          
          # Create a basic HTML wrapper template for Pandoc
          HTML_TEMPLATE_FILE="cpi-artifacts/$PKG_ID/template.html"
          echo "<!DOCTYPE html>" > "$HTML_TEMPLATE_FILE"
          echo "<html><head>" >> "$HTML_TEMPLATE_FILE"
          echo "<meta charset=\"utf-8\">" >> "$HTML_TEMPLATE_FILE"
          echo "<title>$PKG_ID Documentation</title>" >> "$HTML_TEMPLATE_FILE"
          echo "$CSS_STYLE" >> "$HTML_TEMPLATE_FILE"
          echo "</head><body>" >> "$HTML_TEMPLATE_FILE"
          
          # Start content insertion after the body tag in the template (Pandoc will do this)
          # Now, convert each Markdown file to a temporary HTML file
          for IFLOW_NAME in $IFLOW_ROOT_NAMES; do
              INPUT_MD="cpi-artifacts/$PKG_ID/$IFLOW_NAME/${IFLOW_NAME}_Summary.md"
              TEMP_HTML="cpi-artifacts/$PKG_ID/$IFLOW_NAME/${IFLOW_NAME}_Summary_TEMP.html"
              
              if [ -f "$INPUT_MD" ]; then
                  echo "::notice file=$IFLOW_NAME::Converting Markdown to temporary HTML for $IFLOW_NAME."
                  
                  # Use the official Pandoc image to convert MD to HTML
                  /usr/bin/docker run --rm \
                      -v "$(pwd):/data" \
                      pandoc/latex \
                      "$INPUT_MD" \
                      -o "$TEMP_HTML" \
                      --embed-resources \
                      --standalone \
                      --self-contained \
                      --template "$HTML_TEMPLATE_FILE" \
                      --metadata pagetitle="$IFLOW_NAME Documentation"
                      
                  echo "::notice file=$IFLOW_NAME::Temporary HTML created at $TEMP_HTML"
              fi
          done
          
          # Concatenate all temporary HTML files into one main document, including the repeating header/footer block
          OUTPUT_HTML="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation_FINAL.html"
          TEMP_HTML_FILES=$(find "cpi-artifacts/$PKG_ID" -type f -name '*_Summary_TEMP.html' | sort)
          
          # Start the final HTML file with the wrapper
          echo "<!DOCTYPE html>" > "$OUTPUT_HTML"
          echo "<html><head>" >> "$OUTPUT_HTML"
          echo "<meta charset=\"utf-8\">" >> "$OUTPUT_HTML"
          echo "<title>$PKG_ID Documentation</title>" >> "$OUTPUT_HTML"
          echo "$CSS_STYLE" >> "$OUTPUT_HTML"
          echo "</head><body>" >> "$OUTPUT_HTML"
          
          # The repeating header MUST be inserted ONLY ONCE and declared as the running element
          echo "$REPEATING_HEADER" >> "$OUTPUT_HTML"

          for FILE in $TEMP_HTML_FILES; do
              # Add a page break before the content of the next iFlow HTML
              echo "<div style=\"page-break-before: always;\"></div>" >> "$OUTPUT_HTML"
              # Append the content of the temporary HTML (skipping its <html>, <head>, <body> tags)
              awk '/<body[^>]*>/,/<\/body>/' "$FILE" | grep -v 'body' >> "$OUTPUT_HTML"
              rm -f "$FILE"
          done
          
          echo "</body></html>" >> "$OUTPUT_HTML"
          echo "concatenated_file_path=$OUTPUT_HTML" >> $GITHUB_OUTPUT


      - name: üìÑ Convert Final HTML to PDF using Official Pandoc/LaTeX
        if: steps.documentation_step.outputs.docs_generated == 'true'
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          INPUT_HTML: ${{ steps.documentation_step.outputs.concatenated_file_path }}
          OUTPUT_PDF: cpi-artifacts/${{ github.event.inputs.package_id }}/Combined_CPI_Documentation.pdf
          
        run: |
          INPUT_HTML_PATH="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation_FINAL.html"
          OUTPUT_PDF_PATH="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.pdf"
          
          echo "::notice::Starting final HTML to PDF conversion using pandoc/latex."
          
          # Use the official Pandoc image to convert the single combined HTML file to PDF
          # Using --pdf-engine=weasyprint can handle the HTML/CSS better for repeating headers,
          # but we default to the built-in LuaLaTeX if weasyprint isn't available in the standard image.
          # We rely on the CSS 'running' element trick for the header, which requires a robust PDF engine.
          /usr/bin/docker run --rm \
              -v "$(pwd):/data" \
              pandoc/latex \
              --pdf-engine=xelatex \
              "$INPUT_HTML_PATH" \
              -o "$OUTPUT_PDF_PATH" \
              --toc \
              -V geometry:margin=0.5in \
              -V mainfont="Arial"
              
          echo "::notice::Final PDF generated successfully at $OUTPUT_PDF_PATH"

      # --- END DEFINITIVE PDF GENERATION STEPS (Pandoc/LaTeX) ---


      - name: Commit All Generated Files (MD and PDF)
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
                      
          PKG_ID="${{ github.event.inputs.package_id }}"
          # Commit both Markdown and the new PDF files
          OUTPUT_PATH_MD="cpi-artifacts/$PKG_ID/**/*_Summary.md"
          OUTPUT_PATH_FINAL_HTML="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation_FINAL.html"
          OUTPUT_PATH_PDF="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.pdf"
                      
          git add "$OUTPUT_PATH_MD"
          git add "$OUTPUT_PATH_FINAL_HTML"
          git add "$OUTPUT_PATH_PDF"
                      
          if git diff --cached --quiet "$OUTPUT_PATH_MD" && git diff --cached --quiet "$OUTPUT_PATH_FINAL_HTML" && git diff --cached --quiet "$OUTPUT_PATH_PDF"; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              git commit -m "ü§ñ DOCS: Generated/Updated iFlow summaries (MD) and Combined PDF for package: $PKG_ID (Official Pandoc/LaTeX conversion)."
              git push
              echo "‚úÖ All documentation and the combined PDF committed and pushed to repository."
          fi
