name: ðŸ¤– test Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure. Consolidate Groovy, XSLT, and iFlow logic into the relevant sections (5, 6, and 7).

          The 10 mandatory sections are:
          1. High-level architecture
          2. Purpose of this iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary
          7. Groovy script explanations
          8. Error handling
          9. Security/authentication
          10. High-Level Process Flow Diagram (Mermaid 'graph TD')"

          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)

          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found in package '$PKG_ID'."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/iFlow_Summary.md"

            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME"

            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)

            if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "âš ï¸ No artifacts inside: $IFLOW_DIR"
              continue
            fi

            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done

            USER_QUERY="Synthesize documentation using the 10 sections.

            \`\`\`text
            $FULL_ARTIFACT_CONTENT
            \`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')

            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  âœ… Documentation generated."
                echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                break
              else
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "âš ï¸ API error: $ERROR_MSG (Retry $RETRY_COUNT/$MAX_RETRIES)..."
                sleep "$DELAY"
              fi
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Failed to generate documentation for $IFLOW_NAME"
            fi

            echo "=================================================="
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/iFlow_Summary.md"

          git add "$OUTPUT_PATH"

          if git diff --cached --quiet "$OUTPUT_PATH"; then
            echo "No changes in documentation. Skipping commit."
          else
            git commit -m "ðŸ¤– DOCS: Generated/Updated iFlow summaries for package: $PKG_ID (GPT-4o mini)."
            git push
            echo "âœ… Documentation committed."
          fi

