name: ðŸ¤– test Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFconverter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate iFlow Documentation + Architecture Diagram
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          API_URL_CHAT="https://api.openai.com/v1/chat/completions"
          API_URL_IMAGE="https://api.openai.com/v1/images/generations"
          MODEL_NAME="gpt-4o-mini"
          IMAGE_MODEL="gpt-image-1"

          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Generate documentation with the following 10 mandatory sections:
          1. High-level architecture
          2. Purpose of this iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary
          7. Groovy script explanations
          8. Error handling
          9. Security/authentication
          10. High-Level Architecture Diagram (architecture.png will appear under this section)
          "

          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \))
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)

          ALL_DOCS_GENERATED=false

          for IFLOW_NAME in $IFLOW_ROOT_NAMES; do
            IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_NAME"
            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME"

            OUTPUT_DOC="$IFLOW_DIR/iFlow_Summary.md"
            OUTPUT_IMG="$IFLOW_DIR/architecture.png"

            FULL_ARTIFACT_CONTENT=""
            FILES=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \))

            for FILE in $FILES; do
              FULL_ARTIFACT_CONTENT+="\n--- START $FILE ---\n$(cat "$FILE")\n--- END $FILE ---\n"
            done

            USER_QUERY="Generate full documentation using the required 10-point structure.

            \`\`\`text
            $FULL_ARTIFACT_CONTENT
            \`\`\`"

            PAYLOAD=$(jq -n \
              --arg sys "$SYSTEM_PROMPT" \
              --arg usr "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                temperature: 0.1,
                messages: [
                  { "role": "system", "content": $sys },
                  { "role": "user", "content": $usr }
                ]
              }')

            # === TEXT GENERATION ===
            RETRIES=3 ; COUNT=0 ; SUCCESS=false

            while [ $COUNT -lt $RETRIES ]; do
              RESPONSE=$(curl -s -X POST "$API_URL_CHAT" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD")

              DOC=$(echo "$RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$DOC" != "null" ] && [ -n "$DOC" ]; then
                echo "  âœ… Documentation generated."
                echo "$DOC" > "$OUTPUT_DOC"
                SUCCESS=true
                break
              fi

              COUNT=$((COUNT+1))
              echo "Retrying text generation ($COUNT/$RETRIES)..."
              sleep $((2**COUNT))
            done

            if [ "$SUCCESS" = false ]; then
              echo "âŒ Failed to generate text documentation for $IFLOW_NAME"
              continue
            fi

            # === IMAGE GENERATION using SAFE JQ JSON BUILD ===
            IMAGE_PROMPT="Generate a clean, professional SAP-style High-Level Integration Architecture Diagram for iFlow '$IFLOW_NAME'.
            Include: Sender â†’ SAP BTP (API Mgmt + Cloud Integration) â†’ Receiver.
            Use SAP Blue theme, numbered arrows, enterprise architecture layout.
            Output: PNG."

            echo "Generating architecture image safely..."

            IMAGE_PAYLOAD=$(jq -n \
              --arg model "$IMAGE_MODEL" \
              --arg prompt "$IMAGE_PROMPT" \
              --arg size "1024x1024" \
              '{
                model: $model,
                prompt: $prompt,
                size: $size
              }')

            IMAGE_RESPONSE=$(curl -s -X POST "$API_URL_IMAGE" \
              -H "Authorization: Bearer '"$OPENAI_API_KEY"'" \
              -H "Content-Type: application/json" \
              -d "$IMAGE_PAYLOAD")

            # Save raw API response for debugging
            echo "$IMAGE_RESPONSE" > "$IFLOW_DIR/image_api_raw_response.json"

            IMG_DATA=$(echo "$IMAGE_RESPONSE" | jq -r ".data[0].b64_json")

            if [ "$IMG_DATA" = "null" ] || [ -z "$IMG_DATA" ]; then
              echo "âŒ Image generation failed. See image_api_raw_response.json"
            else
              echo "$IMG_DATA" | base64 -d > "$OUTPUT_IMG"
              echo "  ðŸ–¼ï¸ Image saved: $OUTPUT_IMG"

              # Insert inside documentation only under section 10
              sed -i "/^10\./a ![Architecture](architecture.png)\n" "$OUTPUT_DOC"
            fi

            ALL_DOCS_GENERATED=true
            echo "=================================================="
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit Documentation + Images
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"

          # Add ONLY existing files (prevents fatal errors)
          DOC_FILES=$(git ls-files -o -- cpi-artifacts/$PKG_ID/**/iFlow_Summary.md)
          if [ -n "$DOC_FILES" ]; then git add $DOC_FILES; fi

          IMG_FILES=$(git ls-files -o -- cpi-artifacts/$PKG_ID/**/architecture.png)
          if [ -n "$IMG_FILES" ]; then git add $IMG_FILES; fi

          RAW_FILES=$(git ls-files -o -- cpi-artifacts/$PKG_ID/**/image_api_raw_response.json)
          if [ -n "$RAW_FILES" ]; then git add $RAW_FILES; fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ðŸ¤– Updated CPI iFlow Documentation + Architecture Diagram for package: $PKG_ID"
            git push
          fi

