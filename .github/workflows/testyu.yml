name: ðŸ¤– test Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          GIT_USER: ${{ github.actor }}
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect..."

          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \))

          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do

            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
            CLEAN_IFLOW_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')

            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f -name '*.xml' -o -name '*.groovy' -o -name '*.iflw')

            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FULL_ARTIFACT_CONTENT+="\n--- START ARTIFACT: $INPUT_FILE ---\n$(cat "$INPUT_FILE")\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done

            USER_QUERY="Generate documentation for '$IFLOW_NAME'.\n\`\`\`\n$FULL_ARTIFACT_CONTENT\n\`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role:"system", content:$system},
                  {role:"user", content:$query}
                ],
                temperature:0.1
              }')

            API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

            if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then

              AUTHOR="Nidhi Srivastava"
              DATE="2025-12-01"
              VERSION="Draft"
              PROJECT_TITLE="AI Tech Specification Project"

              # BUILD COVER PAGE USING printf (YAML SAFE)
              COVER_PAGE_CONTENT=$(printf "%s\n" "
<p align=\"right\">SAP / motiveminds</p>

<br><br><br><br>

<h1 style=\"color:#1f4e79; font-size:3em; text-align:left;\">
$PROJECT_TITLE - $CLEAN_IFLOW_NAME
</h1>

<br><br>

<table style=\"width:60%; border-collapse: collapse;\" border=\"1\">
<tr>
  <td><strong>Author</strong></td>
  <td>$AUTHOR</td>
</tr>
<tr>
  <td><strong>Date</strong></td>
  <td>$DATE</td>
</tr>
<tr>
  <td><strong>Version</strong></td>
  <td>$VERSION</td>
</tr>
</table>

<br><br><br><br><br><br><br>
")

              echo "$COVER_PAGE_CONTENT$GENERATED_TEXT" > "$OUTPUT_FILE"

              ALL_DOCS_GENERATED=true
            fi

          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit All Generated Documents
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"
          git commit -m "Updated documentation with cover page" || echo "No changes"
          git push || true



