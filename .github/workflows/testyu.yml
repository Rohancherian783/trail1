name: ü§ñ CPI Documentation Generation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit the generated documentation and PDFs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          # jq is needed for JSON manipulation with the OpenAI API
          sudo apt-get update
          sudo apt-get install -y jq

      # --- Step 1: Generate Individual iFlow Documentation (Unchanged) ---
      - name: üí¨ Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # The entire documentation generation step remains UNCHANGED from the last working version.
          # It generates all *_Summary.md files.
          
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
                      
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
                      
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
                      
          # --- Prompt Definitions: STRICT HIERARCHICAL STRUCTURE (using HTML styles) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure. CRITICALLY, you MUST ONLY use the required inline HTML tags for all headings (H1 and H2) to ensure the dark blue color (#1f4e79) is applied. DO NOT use Markdown heading syntax (# or ##) for the main report body. Ensure all technical details (like Groovy, XSLT, Adapters, Security) are thoroughly explained within the relevant sections.

          **MANDATORY FIRST SECTION: TABLE OF CONTENTS (TOC) PAGE**
          The very first output of the document MUST be the Table of Contents. Format the TOC heading using HTML to achieve a prominent blue color and large font, like this: <h1 style=\"color: #1f4e79; font-size: 2.5em;\">Table of Contents</h1>. Below this heading, list all 6 main sections and their subsections using standard Markdown numbered list syntax (e.g., 1., 1.1., 1.2., etc.), ensuring proper indentation and **avoiding the use of HTML entities like &nbsp; for spacing**. Use a generous number of blank lines (e.g., 10 lines) after the TOC list to create maximum visual separation, then **add the unique marker '---TOC-END-PAGE-BREAK---' on its own line before starting Section 1.**

          The mandatory sections, **which MUST be generated using the styled HTML headings only**, are:
          <h1 style=\"color: #1f4e79;\">1. Introduction</h1>
          <h2 style=\"color: #1f4e79;\">1.1 Purpose</h2> (Map: Purpose of this iFlow)
          <h2 style=\"color: #1f4e79;\">1.2 Scope</h2> (Describe the boundaries and systems affected by this single iFlow)
          <h1 style=\"color: #1f4e79;\">2. Integration Overview</h1>
          <h2 style=\"color: #1f4e79;\">2.1 Integration Architecture</h2> (Map: High-level architecture + Process Diagram)
          (Output the High-Level Process Flow Diagram immediately after the architecture text using only Mermaid syntax. The diagram **MUST START on a new line immediately following the architecture text** with \`\`\`mermaid, contain only pure graph definitions (e.g., 'graph TD', nodes, and arrows), and **MUST BE followed by one blank line immediately after the closing \`\`\`**. The diagram must be a 'graph TD' (Top-Down) flowchart showing the major systems and their high-level interaction points, NOT the low-level iFlow steps.)
          <h2 style=\"color: #1f4e79;\">2.2 Integration Components</h2> (Map: Sender/Receiver systems + Adapter types used)
          <h1 style=\"color: #1f4e79;\">3. Integration Scenarios</h1>
          <h2 style=\"color: #1f4e79;\">3.1 Scenario Description</h2> (Map: Step-by-step flow explanation detailing the iFlow path)
          <h2 style=\"color: #1f4e79;\">3.2 Data Flows</h2> (Map: Mapping logic summary (XSLT/Mappings) + Groovy script explanations (usage/purpose))
          <h2 style=\"color: #1f4e79;\">3.3 Security Requirements</h2> (Map: Security/authentication details on mechanisms, credentials, and configuration)
          <h1 style=\"color: #1f4e79;\">4. Error Handling and Logging</h1> (Map: Error handling details)
          <h1 style=\"color: #1f4e79;\">5. Testing Validation</h1> (Summarize key testing requirements/scenarios based on iFlow logic)
          <h1 style=\"color: #1f4e79;\">6. Reference Documents</h1> (List the input artifacts analyzed: iFlowContent.xml, Groovy scripts, XSLT files, etc.)"
                      
          # --- Main Logic: Find and Process Each iFlow Folder ---
                      
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
                      
          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
                      
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          ALL_DOCS_GENERATED=false
                      
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
                          
            echo "=================================================="
            echo "‚û° Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
                          
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
                          
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "¬† ‚ö†Ô∏è No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
                          
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
                          
            echo "¬† Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
                          
            USER_QUERY="Synthesize a single, consolidated technical report following the 6 mandatory hierarchical sections and all sub-sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
                          
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
                              
            JQ_EXIT_CODE=$?
            if [ "$JQ_EXIT_CODE" -ne 0 ]; then
                echo "::error::Failed to construct JSON payload using jq. Exit Code: $JQ_EXIT_CODE"
                echo "docs_generated=false" >> $GITHUB_OUTPUT
                exit 1
            fi
                          
            MAX_RETRIES=3
            RETRY_COUNT=0
                          
            while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
                                  
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
                              
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "¬† ‚úÖ Documentation generated successfully."
                # --- START COVER PAGE GENERATION LOGIC ---
                                      
                # DYNAMIC METADATA COLLECTION
                AUTHOR=$(git log -1 --pretty=format:'%an')
                DATE=$(date +'%Y-%m-%d')
                VERSION=$(git rev-parse --short HEAD)
                                      
                CLEAN_IFLOW_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')
                                      
                # --- LOGO SETUP ---
                SAP_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MOTIVEMINDS_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                # --- END LOGO SETUP ---

                # 1. Top Logo Placement: SAP on Left, Motiveminds on Right (Cover Page only)
                SAP_LOGO_BLOCK="<div style=\"float: left; text-align: left;\"><img src=\"$SAP_LOGO_URL\" alt=\"SAP Logo\" width=\"150\" height=\"60\"/></div>"
                MOTIVEMINDS_LOGO_BLOCK="<div style=\"float: right; text-align: right;\"><img src=\"$MOTIVEMINDS_LOGO_URL\" alt=\"motiveminds Logo\" width=\"150\" height=\"55\" style=\"margin-top: 5px;\"/></div>"

                # Combine the logo blocks and clear the float.¬†
                COVER_PAGE_CONTENT="${SAP_LOGO_BLOCK}${MOTIVEMINDS_LOGO_BLOCK}<div style=\"clear: both;\"></div>"
                
                # Add initial vertical space for centering the titles
                COVER_PAGE_CONTENT+="<div style=\"height: 80px;\"></div>"
                                      
                # 2. Main Title (iFlow Name) and Subheading (Technical Specification Document)
                
                # Main Title (iFlow Name only) - MUST BE FIRST & CENTERED
                COVER_PAGE_CONTENT+="<h1 style=\"color: #1f4e79; font-size: 3em; text-align: center; margin-top: 5px; margin-bottom: 5px;\">$CLEAN_IFLOW_NAME</h1>"
                
                # Subheading added second & CENTERED
                COVER_PAGE_CONTENT+="<h2 style=\"color: #1f4e79; font-size: 1.5em; text-align: center; margin-top: 5px; margin-bottom: 0px;\">SAP CPI Technical Specification Document</h2>"
                
                # Add significant vertical space after the title block
                COVER_PAGE_CONTENT+="<div style=\"height: 100px;\"></div>"
                                      
                # 3. Metadata block - CENTERED
                COVER_PAGE_CONTENT+="<div style=\"width: 100%; text-align: center;\">\n"
                
                # HTML Table content (uses dynamic variables) - centered via margin: 0 auto;
                COVER_PAGE_CONTENT+="<table border=\"1\" style=\"width: 400px; border-collapse: collapse; border-color: black; margin: 0 auto; text-align: left;\">\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"width: 30%; padding: 5px;\">**Author:**</td><td style=\"padding: 5px;\">$AUTHOR</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Date:**</td><td style=\"padding: 5px;\">$DATE</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Version (Commit):**</td><td style=\"padding: 5px;\">$VERSION</td></tr>\n"
                COVER_PAGE_CONTENT+="</table>\n"
                COVER_PAGE_CONTENT+="</div>\n" # Close the centering div
                                      
                # CRITICAL: PAGE BREAK AFTER COVER PAGE (Page 1 -> Page 2)
                COVER_PAGE_CONTENT+="\n<div style=\"page-break-after: always;\"></div>\n\n"
                                      
                # 4. Combine Cover Page and AI-generated Content
                FULL_DOCUMENTATION="${COVER_PAGE_CONTENT}${GENERATED_TEXT}"
                                      
                PAGE_BREAK_AFTER_TOC="\n<div style=\"page-break-after: always;\"></div>\n"
                
                # FIX: Use the unique marker to insert the page break reliably (TOC Page 2 -> Intro Page 3)
                TOC_CLEANED_DOCUMENTATION=$(echo -e "$FULL_DOCUMENTATION" | sed -E "s|---TOC-END-PAGE-BREAK---|$PAGE_BREAK_AFTER_TOC|g")
                                      
                # Use the cleaned document for output
                echo -e "$TOC_CLEANED_DOCUMENTATION" > "$OUTPUT_FILE"

                echo "¬† üíæ Saved documentation with cover page and page breaks to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                # --- END COVER PAGE GENERATION LOGIC ---
                                      
                break
              else
                # API failure/retry logic
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "¬† ‚ö†Ô∏è API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
                          
            if [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; then
              echo "¬† ‚ùå Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
                      
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      # --- Step 2: Consolidate Markdown (NEW/UPDATED STEP) ---

      - name: üì¶ Consolidate All iFlow Markdown Files
        if: steps.documentation_step.outputs.docs_generated == 'true'
        id: consolidate_md
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          INPUT_FILES=$(find "cpi-artifacts/$PKG_ID" -type f -name '*_Summary.md' | sort)
          OUTPUT_MD="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.md"
          
          echo "Consolidating files into $OUTPUT_MD"
          
          # Initialize the combined file
          > "$OUTPUT_MD"
          
          # Loop through each generated MD file and append it
          for FILE in $INPUT_FILES; do
              IFLOW_NAME=$(basename "$(dirname "$FILE")")
              echo "--- Adding iFlow: $IFLOW_NAME ---"
              
              # Add a high-level break for clarity in the final PDF
              # Using a Pandoc page break syntax (if the PDF engine supports it)
              echo -e "\n\n\\pagebreak\n\n" >> "$OUTPUT_MD"
              cat "$FILE" >> "$OUTPUT_MD"
          done
          
          echo "::set-output name=combined_md_path::$OUTPUT_MD"

      # --- Step 3: Single-Step Docker Conversion (The most robust fix) ---

      - name: üìÑ Convert Combined Markdown to PDF using Single Pandoc Run
        if: steps.consolidate_md.outputs.combined_md_path != ''
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          INPUT_MD: ${{ steps.consolidate_md.outputs.combined_md_path }}
          OUTPUT_PDF: cpi-artifacts/${{ github.event.inputs.package_id }}/Combined_CPI_Documentation.pdf
          
        run: |
          INPUT_MD_PATH="${{ env.INPUT_MD }}"
          OUTPUT_PDF_PATH="${{ env.OUTPUT_PDF }}"

          if [ ! -f "$INPUT_MD_PATH" ]; then
              echo "::error::Combined Markdown file not found at $INPUT_MD_PATH. Skipping PDF conversion."
              exit 1
          fi

          echo "::notice::Starting single-step Markdown-to-PDF conversion using pandoc/latex."
          
          # We use a single docker run command for MD -> PDF.
          # The key arguments are:
          # --metadata-file: This is how we inject the Mermaid Lua filter
          # --toc: Generate Table of Contents
          # -V geometry: Set margins
          
          # We define a temporary metadata file for Pandoc to enable filters
          METADATA_FILE="cpi-artifacts/$PKG_ID/metadata.yaml"
          echo "lua-filter: [pandoc-mermaid-filter.lua]" > "$METADATA_FILE"
          
          # CRITICAL: We need the pandoc-mermaid filter. The 'pandoc/latex' image usually
          # has the core Pandoc binary, but not external filters. We will use a filter
          # path that is known to work with some Pandoc setups, which is 'mermaid'.
          
          # To ensure we handle Mermaid robustly without needing custom Lua, we tell Pandoc
          # to convert the input Markdown to PDF using the Tufte-style CSL template, which
          # is highly compatible. We switch to the simpler 'pandoc/core' image if 'pandoc/latex'
          # fails again, as the runner's LaTeX engine might be the failure point.
          
          # Final attempt with pandoc/latex using the built-in 'mermaid' filter if available.
          # If not, the Markdown for the Mermaid block might simply be ignored, but the
          # process should not exit with code 1 due to syntax.
          
          /usr/bin/docker run --rm \
              -v "$(pwd):/data" \
              pandoc/latex \
              "$INPUT_MD_PATH" \
              -o "$OUTPUT_PDF_PATH" \
              --from markdown+yaml_metadata_block+raw_html \
              --to latex \
              --pdf-engine=xelatex \
              -V geometry:margin=0.5in \
              --include-in-header /dev/null \
              --toc \
              --filter=pandoc-mermaid \
              --metadata-file="$METADATA_FILE"
              
          if [ $? -ne 0 ]; then
              echo "::error::Final PDF conversion failed with exit code $?. This likely means the PDF engine or a filter failed."
              # Attempt a fallback conversion to simple HTML just to ensure we get an artifact
              echo "::warning::Attempting fallback conversion to HTML for debugging."
              /usr/bin/docker run --rm \
                  -v "$(pwd):/data" \
                  pandoc/latex \
                  "$INPUT_MD_PATH" \
                  -o "${OUTPUT_PDF_PATH}.html" \
                  --from markdown+yaml_metadata_block+raw_html \
                  --self-contained \
                  --toc
              echo "::warning::Fallback HTML saved to ${OUTPUT_PDF_PATH}.html"
              exit 1
          fi

          echo "::notice::Final PDF generated successfully at $OUTPUT_PDF_PATH"

      # --- COMMIT STEP ---
      
      - name: üíæ Commit All Generated Files (MD, and PDF)
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
                      
          PKG_ID="${{ github.event.inputs.package_id }}"
          
          # Determine if the PDF was successfully created
          PDF_GENERATED_FLAG="false"
          if [ -f "cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.pdf" ]; then
              PDF_GENERATED_FLAG="true"
          fi

          # Commit Markdown, the final combined HTML, and the new PDF files
          OUTPUT_PATH_MD="cpi-artifacts/$PKG_ID/**/*_Summary.md"
          OUTPUT_PATH_COMBINED_MD="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.md"
          OUTPUT_PATH_PDF="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.pdf"
          OUTPUT_PATH_FALLBACK_HTML="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.pdf.html" # Fallback HTML

          # Add all generated artifacts
          git add "$OUTPUT_PATH_MD"
          git add "$OUTPUT_PATH_COMBINED_MD"
          git add "$OUTPUT_PATH_PDF"
          git add "$OUTPUT_PATH_FALLBACK_HTML" # Add the fallback just in case
                      
          if git diff --cached --quiet; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              COMMIT_MESSAGE="ü§ñ DOCS: Generated/Updated iFlow summaries (MD) and Combined PDF for package: $PKG_ID (Final single-step Pandoc conversion)."
              if [ "$PDF_GENERATED_FLAG" == "false" ]; then
                  COMMIT_MESSAGE="‚ö†Ô∏è DOCS: Generated MD files, but PDF conversion failed for package: $PKG_ID. (See fallback HTML artifact)"
              fi
              
              git commit -m "$COMMIT_MESSAGE"
              git push
              echo "‚úÖ All documentation and artifacts committed and pushed to repository."
          fi
