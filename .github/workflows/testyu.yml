name: ü§ñ Generate Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    
    steps:

      # --------------------------
      # CHECKOUT REPO
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------
      # INSTALL jq
      # --------------------------
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # --------------------------
      # GET TODAY‚ÄôS DATE (Dynamic)
      # --------------------------
      - name: Get Today Date
        id: date_step
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # --------------------------
      # GENERATE DOCUMENTATION
      # --------------------------
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}

          # üî• Dynamic Metadata
          AUTHOR: "Rohan Cherian"
          DATE: ${{ steps.date_step.outputs.today }}
          VERSION: "Draft"

        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. 
          You must generate a SINGLE Markdown file with:
          
          ============================
          1Ô∏è‚É£ MANDATORY COVER PAGE  
          ============================

          Insert EXACTLY this HTML cover page at the top of the document.
          Replace {{AUTHOR}}, {{DATE}}, {{VERSION}}, and {{IFLOW_NAME}} dynamically.

          <!-- COVER PAGE START -->

          <table style='width:100%; border-collapse:collapse;'>
            <tr>
              <td style='text-align:left; border:none;'>
                <img src='https://upload.wikimedia.org/wikipedia/commons/5/59/SAP_2011_logo.svg' width='120' />
              </td>
              <td style='text-align:right; font-size:1.1em; color:#333; border:none;'>
                ¬© MotiveMinds
              </td>
            </tr>
          </table>

          <div style='text-align:center; margin-top:120px; margin-bottom:120px;'>
            <h1 style='color:#1f4e79; font-size:2.8em;'>
              {{IFLOW_NAME}} ‚Äì Technical Specification
            </h1>
          </div>

          <table style='margin-left:auto; margin-right:auto; width:40%; border:1px solid #000; border-collapse:collapse; font-size:1.1em;'>
            <tr>
              <td style='border:1px solid #000; padding:6px; font-weight:bold;'>Author:</td>
              <td style='border:1px solid #000; padding:6px;'>{{AUTHOR}}</td>
            </tr>
            <tr>
              <td style='border:1px solid #000; padding:6px; font-weight:bold;'>Date:</td>
              <td style='border:1px solid #000; padding:6px;'>{{DATE}}</td>
            </tr>
            <tr>
              <td style='border:1px solid #000; padding:6px; font-weight:bold;'>Version:</td>
              <td style='border:1px solid #000; padding:6px;'>{{VERSION}}</td>
            </tr>
          </table>

          <div style='page-break-after: always;'></div>

          <!-- COVER PAGE END -->


          ============================
          2Ô∏è‚É£ TABLE OF CONTENTS  
          ============================
          Use HTML heading for the TOC title:
          <h1 style='color:#1f4e79; font-size: 2.5em;'>Table of Contents</h1>

          Include all 6 main sections and subsections using Markdown numbers.


          ============================
          3Ô∏è‚É£ SECTIONS 1‚Äì6  
          ============================
          Follow the strict structure:

          1. Introduction  
            1.1 Purpose  
            1.2 Scope  
          2. Integration Overview  
            2.1 Integration Architecture  
            (‚ö† include Mermaid 'graph TD' diagram)  
            2.2 Integration Components  
          3. Integration Scenarios  
            3.1 Scenario Description  
            3.2 Data Flows  
            3.3 Security Requirements  
          4. Error Handling and Logging  
          5. Testing & Validation  
          6. Reference Documents  
          "

          # Find iFlow files
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \))

          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"

            echo "‚û° Processing $IFLOW_NAME ..."

            FILES=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \))

            FULL_CONTENT=""
            for f in $FILES; do
              FULL_CONTENT+="\n\n--- START ARTIFACT: $f ---\n$(cat $f)\n--- END ARTIFACT: $f ---\n"
            done

            USER_QUERY="Author=${AUTHOR}
Date=${DATE}
Version=${VERSION}
IFLOW_NAME=${IFLOW_NAME}

Generate the complete document with the mandatory cover page, TOC, and sections.

Artifacts:
\`\`\`text
$FULL_CONTENT
\`\`\`
"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{model:$model, messages:[{role:"system",content:$system}, {role:"user",content:$query}], temperature:0.1}')

            API_RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "$PAYLOAD")

            OUTPUT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

            echo "$OUTPUT" > "$OUTPUT_FILE"
            ALL_DOCS_GENERATED=true
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      # --------------------------
      # COMMIT DOCUMENTS
      # --------------------------
      - name: Commit Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ü§ñ Auto-generated iFlow Documentation for package: $PKG_ID"
            git push
            echo "Documentation committed."
          fi


