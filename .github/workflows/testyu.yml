name: ðŸ¤– Test  Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          GIT_USER: ${{ github.actor }}
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure..."

          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \))

          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found in package."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do

            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"

            echo "=================================================="
            echo "âž¡ Processing iFlow: $IFLOW_NAME"

            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \))

            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n$(cat "$INPUT_FILE")\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done

            USER_QUERY="Synthesize a consolidated technical report from the artifacts for the iFlow '$IFLOW_NAME'.\n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')

            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do

              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then

                TODAY=$(date +%Y-%m-%d)
                AUTHOR="$GIT_USER"
                VERSION="Draft"

                # ==========================================================
                # ðŸ”µ YAML-SAFE DYNAMIC COVER PAGE (Option A: First Page)
                # ==========================================================
                COVER_PAGE=$(cat << 'EOF'
<!-- COVER PAGE START -->

<table style="width:100%;">
<tr>
<td align="left">
  <img src="https://upload.wikimedia.org/wikipedia/commons/5/59/SAP_2011_logo.svg" width="120">
</td>
<td align="right">
  <img src="https://i.ibb.co/8cVbZCy/motiveminds-logo.png" width="150">
</td>
</tr>
</table>

<br><br><br><br>

<h1 align="center" style="color:#1f4e79; font-size:2.8em;">
__IFLOW_NAME__ â€“ Technical Specification Document
</h1>

<br><br><br>

<table style="width:60%; margin-left:auto; margin-right:auto; border-collapse: collapse;" border="1">
<tr>
  <td><strong>Author:</strong></td>
  <td>__AUTHOR__</td>
</tr>
<tr>
  <td><strong>Date:</strong></td>
  <td>__DATE__</td>
</tr>
<tr>
  <td><strong>Version:</strong></td>
  <td>__VERSION__</td>
</tr>
</table>

<br><br><br><br>

<!-- COVER PAGE END -->
EOF
)

                # Replace placeholders dynamically
                COVER_PAGE="${COVER_PAGE/__IFLOW_NAME__/$IFLOW_NAME}"
                COVER_PAGE="${COVER_PAGE/__AUTHOR__/$AUTHOR}"
                COVER_PAGE="${COVER_PAGE/__DATE__/$TODAY}"
                COVER_PAGE="${COVER_PAGE/__VERSION__/$VERSION}"

                # Write final output: COVER FIRST â†’ GPT CONTENT NEXT
                echo "$COVER_PAGE" > "$OUTPUT_FILE"
                echo "$GENERATED_TEXT" >> "$OUTPUT_FILE"

                echo "ðŸ’¾ Saved documentation to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((2**RETRY_COUNT))
            done

            echo "=================================================="
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT
          
      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*_Summary.md"
          
          if git diff --cached --quiet; then
            echo "No changes detected."
          else
            git commit -m "ðŸ¤– DOCS: Generated/Updated iFlow summaries with Cover Page"
            git push
            echo "âœ… Documentation committed."
          fi








