name: ðŸ¤– CPI Documentation Generation (MD â†’ DOCX)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # ---------------------------------------------------------
    # CHECKOUT
    # ---------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # INSTALL SYSTEM DEPENDENCIES
    # ---------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq pandoc python3 python3-pip nodejs npm
        sudo npm install -g @mermaid-js/mermaid-cli
        python3 -m pip install --upgrade pip
        python3 -m pip install python-docx requests

    # ---------------------------------------------------------
    # CREATE PYTHON SCRIPT SAFELY (NO YAML BREAKING)
    # ---------------------------------------------------------
    - name: Create md_to_docx.py converter script
      run: |
        mkdir -p .github/scripts

        cat << 'EOF' > .github/scripts/md_to_docx.py
#!/usr/bin/env python3
import sys, os, re, subprocess, requests
from pathlib import Path
from docx import Document
from docx.shared import Inches

def download(url, dest):
    r = requests.get(url, timeout=30)
    r.raise_for_status()
    with open(dest, "wb") as f:
        f.write(r.content)

def convert_mermaid(md_path):
    text = md_path.read_text()
    pattern = re.compile(r"```mermaid\s*(.*?)```", re.DOTALL)
    matches = pattern.findall(text)
    if not matches:
        return md_path

    assets_dir = md_path.parent / (md_path.stem + "_assets")
    assets_dir.mkdir(exist_ok=True)

    for idx, diagram in enumerate(matches, start=1):
        mmd = assets_dir / f"diagram_{idx}.mmd"
        png = assets_dir / f"diagram_{idx}.png"
        mmd.write_text(diagram.strip())
        subprocess.run(["mmdc", "-i", str(mmd), "-o", str(png)], check=True)
        text = text.replace(f"```mermaid\n{diagram}```", f"![Diagram]({png.name})")

    md_path.write_text(text)
    return md_path

def md_to_docx(md_path, docx_path, sap_logo, mm_logo):
    convert_mermaid(md_path)

    subprocess.run(["pandoc", str(md_path), "-o", str(docx_path)], check=True)

    doc = Document(docx_path)
    section = doc.sections[0]
    header = section.header
    header.is_linked_to_previous = False

    table = header.add_table(rows=1, cols=2)
    table.autofit = True

    left = table.rows[0].cells[0].paragraphs[0].add_run()
    left.add_picture(sap_logo, width=Inches(1.5))

    right_p = table.rows[0].cells[1].paragraphs[0]
    right_p.alignment = 2
    right = right_p.add_run()
    right.add_picture(mm_logo, width=Inches(1.5))

    doc.save(docx_path)

if __name__ == "__main__":
    md = Path(sys.argv[1])
    docx = Path(sys.argv[2])
    sap = sys.argv[3]
    mm = sys.argv[4]
    md_to_docx(md, docx, sap, mm)
EOF

        chmod +x .github/scripts/md_to_docx.py

    # ---------------------------------------------------------
    # MAIN DOCUMENT GENERATION
    # ---------------------------------------------------------
    - name: Generate documentation (OpenAI + MD â†’ DOCX)
      id: documentation_step
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PKG_ID: ${{ github.event.inputs.package_id }}
        SAP_LOGO_URL: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
        MM_LOGO_URL: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
      run: |
        set -euo pipefail

        API_URL="https://api.openai.com/v1/chat/completions"
        MODEL="gpt-4o-mini"
        BASE="cpi-artifacts/${PKG_ID}"

        if [ ! -d "$BASE" ]; then
          echo "::error::Package not found"
          echo "docs_generated=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        # SYSTEM PROMPT
        cat << 'EOF' > /tmp/system_prompt.txt
You are a senior SAP CPI Technical Architect.
Generate a structured Markdown document containing:
- A Table of Contents
- 6 structured sections
- Mermaid graph TD diagram in section 2.1
EOF

        IFlows=$(find "$BASE" -type f -name "*iFlowContent.xml" | sed "s|$BASE/||" | cut -d/ -f1 | sort -u)

        ALL=false

        for flow in $IFlows; do
          DIR="$BASE/$flow"
          MD="$DIR/${flow}_Summary.md"
          DOCX="$DIR/${flow}_Summary.docx"

          echo "Processing $flow ..."

          CONTENT=""
          for f in $(find "$DIR" -type f \( -name "*.xml" -o -name "*.groovy" -o -name "*.xslt" -o -name "*.iflw" \)); do
            CONTENT="$CONTENT\n--- FILE: $f ---\n$(cat "$f")\n"
          done

          QUERY="Generate a full documentation:\n\`\`\`\n$CONTENT\n\`\`\`"

          PAYLOAD=$(jq -n \
            --arg sys "$(cat /tmp/system_prompt.txt)" \
            --arg user "$QUERY" \
            --arg model "$MODEL" \
            '{model: $model, messages:[{role:"system",content:$sys},{role:"user",content:$user}] }')

          RES=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          TEXT=$(echo "$RES" | jq -r '.choices[0].message.content // empty')

          if [ -z "$TEXT" ]; then
            echo "::error::OpenAI failed"
            continue
          fi

          echo -e "$TEXT" > "$MD"
          echo "Written $MD"

          # Download logos
          wget -q "$SAP_LOGO_URL" -O "$DIR/sap.png"
          wget -q "$MM_LOGO_URL" -O "$DIR/mm.png"

          python3 .github/scripts/md_to_docx.py "$MD" "$DOCX" "$DIR/sap.png" "$DIR/mm.png"

          echo "Generated DOCX: $DOCX"
          ALL=true
        done

        echo "docs_generated=$ALL" >> $GITHUB_OUTPUT

    # ---------------------------------------------------------
    # COMMIT RESULTS
    # ---------------------------------------------------------
    - name: Commit generated docs
      if: steps.documentation_step.outputs.docs_generated == 'true'
      run: |
        git config user.email "actions@github.com"
        git config user.name "GitHub Actions"

        git add cpi-artifacts/**/*_Summary.md || true
        git add cpi-artifacts/**/*_Summary.docx || true

        if git diff --cached --quiet; then
          echo "No changes"
        else
          git commit -m "ðŸ¤– Auto-generated MD + DOCX for CPI package"
          git push
        fi


