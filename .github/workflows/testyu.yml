name: ü§ñ test Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq, pandoc, mermaid-cli)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc nodejs npm
          sudo npm install -g @mermaid-js/mermaid-cli

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10 sections:
          1. High-level architecture
          2. Purpose of this iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary
          7. Groovy script explanations
          8. Error handling
          9. Security/authentication
          10. High-Level Process Flow Diagram (Mermaid 'graph TD')"

          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)

          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found in package '$PKG_ID'"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            MD_FILE="$IFLOW_DIR/iFlow_Summary.md"
            PNG_FILE="$IFLOW_DIR/iFlow_Diagram.png"
            DOCX_FILE="$IFLOW_DIR/iFlow_Summary.docx"

            echo "=================================================="
            echo "‚û° Processing iFlow: $IFLOW_NAME"

            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)

            if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "‚ö†Ô∏è No artifacts found in: $IFLOW_DIR"
              continue
            fi

            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n$FILE_CONTENT\n--- END ARTIFACT ---\n"
            done

            USER_QUERY="Synthesize documentation using the 10 mandatory sections:
            \`\`\`text
            $FULL_ARTIFACT_CONTENT
            \`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')

            # Retry Logic
            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "  ‚úÖ Documentation generated."
                echo "$GENERATED_TEXT" > "$MD_FILE"
                ALL_DOCS_GENERATED=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep $((2**RETRY_COUNT))
              fi
            done

            # --- Extract Mermaid Block ---
            MERMAID_CONTENT=$(sed -n '/```mermaid/,/```/p' "$MD_FILE" | sed '1d;$d')

            if [ -n "$MERMAID_CONTENT" ]; then
              echo "$MERMAID_CONTENT" > "$IFLOW_DIR/diagram.mmd"

              echo "Rendering Mermaid Diagram..."
              mmdc -i "$IFLOW_DIR/diagram.mmd" -o "$PNG_FILE"
            fi

            # Replace mermaid code block with image reference
            sed -i "s|```mermaid|![]($PNG_FILE)|g" "$MD_FILE"
            sed -i "/graph TD/,+10d" "$MD_FILE"
            sed -i "s|```||g" "$MD_FILE"

            # Generate DOCX using Pandoc
            pandoc "$MD_FILE" -o "$DOCX_FILE"

            echo "Generated DOCX: $DOCX_FILE"

            echo "=================================================="

          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit All Generated Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/iFlow_Summary.md"
          git add "cpi-artifacts/$PKG_ID/**/iFlow_Summary.docx"
          git add "cpi-artifacts/$PKG_ID/**/iFlow_Diagram.png"

          if git diff --cached --quiet; then
            echo "No new changes. Skipping commit."
          else
            git commit -m "üìù DOCX + Diagram: Documentation updated for package $PKG_ID"
            git push
          fi


