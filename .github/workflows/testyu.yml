name: ü§ñ CPI Documentation Generation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit the generated documentation and PDFs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          # jq is needed for JSON manipulation with the OpenAI API
          sudo apt-get update
          sudo apt-get install -y jq
          # Docker is no longer explicitly needed in the shell steps.

      # --- Step 1: Generate Individual iFlow Documentation (Unchanged) ---
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
                      
          # Base directory where all artifacts for the package are stored
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
                      
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            echo "::error::Please ensure package artifacts were synced first and the Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
                      
          # --- Prompt Definitions: STRICT HIERARCHICAL STRUCTURE (FINAL COLOR/MERMAID FIX) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure. CRITICALLY, you MUST ONLY use the required inline HTML tags for all headings (H1 and H2) to ensure the dark blue color (#1f4e79) is applied. DO NOT use Markdown heading syntax (# or ##) for the main report body. Ensure all technical details (like Groovy, XSLT, Adapters, Security) are thoroughly explained within the relevant sections.

          **MANDATORY FIRST SECTION: TABLE OF CONTENTS (TOC) PAGE**
          The very first output of the document MUST be the Table of Contents. Format the TOC heading using HTML to achieve a prominent blue color and large font, like this: <h1 style=\"color: #1f4e79; font-size: 2.5em;\">Table of Contents</h1>. Below this heading, list all 6 main sections and their subsections using standard Markdown numbered list syntax (e.g., 1., 1.1., 1.2., etc.), ensuring proper indentation and **avoiding the use of HTML entities like &nbsp; for spacing**. Use a generous number of blank lines (e.g., 10 lines) after the TOC list to create maximum visual separation, then **add the unique marker '---TOC-END-PAGE-BREAK---' on its own line before starting Section 1.**

          The mandatory sections, **which MUST be generated using the styled HTML headings only**, are:
          <h1 style=\"color: #1f4e79;\">1. Introduction</h1>
          <h2 style=\"color: #1f4e79;\">1.1 Purpose</h2> (Map: Purpose of this iFlow)
          <h2 style=\"color: #1f4e79;\">1.2 Scope</h2> (Describe the boundaries and systems affected by this single iFlow)
          <h1 style=\"color: #1f4e79;\">2. Integration Overview</h1>
          <h2 style=\"color: #1f4e79;\">2.1 Integration Architecture</h2> (Map: High-level architecture + Process Diagram)
          (Output the High-Level Process Flow Diagram immediately after the architecture text using only Mermaid syntax. The diagram **MUST START on a new line immediately following the architecture text** with \`\`\`mermaid, contain only pure graph definitions (e.g., 'graph TD', nodes, and arrows), and **MUST BE followed by one blank line immediately after the closing \`\`\`**. The diagram must be a 'graph TD' (Top-Down) flowchart showing the major systems and their high-level interaction points, NOT the low-level iFlow steps.)
          <h2 style=\"color: #1f4e79;\">2.2 Integration Components</h2> (Map: Sender/Receiver systems + Adapter types used)
          <h1 style=\"color: #1f4e79;\">3. Integration Scenarios</h1>
          <h2 style=\"color: #1f4e79;\">3.1 Scenario Description</h2> (Map: Step-by-step flow explanation detailing the iFlow path)
          <h2 style=\"color: #1f4e79;\">3.2 Data Flows</h2> (Map: Mapping logic summary (XSLT/Mappings) + Groovy script explanations (usage/purpose))
          <h2 style=\"color: #1f4e79;\">3.3 Security Requirements</h2> (Map: Security/authentication details on mechanisms, credentials, and configuration)
          <h1 style=\"color: #1f4e79;\">4. Error Handling and Logging</h1> (Map: Error handling details)
          <h1 style=\"color: #1f4e79;\">5. Testing Validation</h1> (Summarize key testing requirements/scenarios based on iFlow logic)
          <h1 style=\"color: #1f4e79;\">6. Reference Documents</h1> (List the input artifacts analyzed: iFlowContent.xml, Groovy scripts, XSLT files, etc.)"
                      
          # --- Main Logic: Find and Process Each iFlow Folder ---
                      
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -print)
                      
          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found (no 'iFlowContent.xml' or '*.iflw' files) in package '$PKG_ID'. Skipping documentation."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
                      
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          ALL_DOCS_GENERATED=false
                      
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
                          
            echo "=================================================="
            echo "‚û° Processing iFlow: $IFLOW_NAME (in $IFLOW_DIR)"
                          
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print)
                          
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "¬† ‚ö†Ô∏è No supported artifacts found recursively in iFlow directory: $IFLOW_DIR. Skipping."
                continue
            fi
                          
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
                          
            echo "¬† Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."
                          
            USER_QUERY="Synthesize a single, consolidated technical report following the 6 mandatory hierarchical sections and all sub-sections from the set of artifacts provided below, which belong ONLY to the iFlow '$IFLOW_NAME'. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
                          
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
                              
            JQ_EXIT_CODE=$?
            if [ "$JQ_EXIT_CODE" -ne 0 ]; then
                echo "::error::Failed to construct JSON payload using jq. Exit Code: $JQ_EXIT_CODE"
                echo "docs_generated=false" >> $GITHUB_OUTPUT
                exit 1
            fi
                          
            MAX_RETRIES=3
            RETRY_COUNT=0
                          
            while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
                                  
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
                              
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                echo "¬† ‚úÖ Documentation generated successfully."
                # --- START COVER PAGE GENERATION LOGIC ---
                                      
                # DYNAMIC METADATA COLLECTION
                AUTHOR=$(git log -1 --pretty=format:'%an')
                DATE=$(date +'%Y-%m-%d')
                VERSION=$(git rev-parse --short HEAD)
                                      
                CLEAN_IFLOW_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')
                                      
                # --- LOGO SETUP ---
                SAP_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
                MOTIVEMINDS_LOGO_URL="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
                # --- END LOGO SETUP ---

                # 1. Top Logo Placement: SAP on Left, Motiveminds on Right (Cover Page only)
                SAP_LOGO_BLOCK="<div style=\"float: left; text-align: left;\"><img src=\"$SAP_LOGO_URL\" alt=\"SAP Logo\" width=\"150\" height=\"60\"/></div>"
                MOTIVEMINDS_LOGO_BLOCK="<div style=\"float: right; text-align: right;\"><img src=\"$MOTIVEMINDS_LOGO_URL\" alt=\"motiveminds Logo\" width=\"150\" height=\"55\" style=\"margin-top: 5px;\"/></div>"

                # Combine the logo blocks and clear the float.¬†
                COVER_PAGE_CONTENT="${SAP_LOGO_BLOCK}${MOTIVEMINDS_LOGO_BLOCK}<div style=\"clear: both;\"></div>"
                
                # Add initial vertical space for centering the titles
                COVER_PAGE_CONTENT+="<div style=\"height: 80px;\"></div>"
                                      
                # 2. Main Title (iFlow Name) and Subheading (Technical Specification Document)
                
                # Main Title (iFlow Name only) - MUST BE FIRST & CENTERED
                COVER_PAGE_CONTENT+="<h1 style=\"color: #1f4e79; font-size: 3em; text-align: center; margin-top: 5px; margin-bottom: 5px;\">$CLEAN_IFLOW_NAME</h1>"
                
                # Subheading added second & CENTERED
                COVER_PAGE_CONTENT+="<h2 style=\"color: #1f4e79; font-size: 1.5em; text-align: center; margin-top: 5px; margin-bottom: 0px;\">SAP CPI Technical Specification Document</h2>"
                
                # Add significant vertical space after the title block
                COVER_PAGE_CONTENT+="<div style=\"height: 100px;\"></div>"
                                      
                # 3. Metadata block - CENTERED
                COVER_PAGE_CONTENT+="<div style=\"width: 100%; text-align: center;\">\n"
                
                # HTML Table content (uses dynamic variables) - centered via margin: 0 auto;
                COVER_PAGE_CONTENT+="<table border=\"1\" style=\"width: 400px; border-collapse: collapse; border-color: black; margin: 0 auto; text-align: left;\">\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"width: 30%; padding: 5px;\">**Author:**</td><td style=\"padding: 5px;\">$AUTHOR</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Date:**</td><td style=\"padding: 5px;\">$DATE</td></tr>\n"
                COVER_PAGE_CONTENT+="¬† <tr><td style=\"padding: 5px;\">**Version (Commit):**</td><td style=\"padding: 5px;\">$VERSION</td></tr>\n"
                COVER_PAGE_CONTENT+="</table>\n"
                COVER_PAGE_CONTENT+="</div>\n" # Close the centering div
                                      
                # CRITICAL: PAGE BREAK AFTER COVER PAGE (Page 1 -> Page 2)
                COVER_PAGE_CONTENT+="\n<div style=\"page-break-after: always;\"></div>\n\n"
                                      
                # 4. Combine Cover Page and AI-generated Content
                FULL_DOCUMENTATION="${COVER_PAGE_CONTENT}${GENERATED_TEXT}"
                                      
                PAGE_BREAK_AFTER_TOC="\n<div style=\"page-break-after: always;\"></div>\n"
                
                # FIX: Use the unique marker to insert the page break reliably (TOC Page 2 -> Intro Page 3)
                TOC_CLEANED_DOCUMENTATION=$(echo -e "$FULL_DOCUMENTATION" | sed -E "s|---TOC-END-PAGE-BREAK---|$PAGE_BREAK_AFTER_TOC|g")
                                      
                # Use the cleaned document for output
                echo -e "$TOC_CLEANED_DOCUMENTATION" > "$OUTPUT_FILE"

                echo "¬† üíæ Saved documentation with cover page and page breaks to $OUTPUT_FILE"
                ALL_DOCS_GENERATED=true
                # --- END COVER PAGE GENERATION LOGIC ---
                                      
                break
              else
                # API failure/retry logic
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r ".error.message // \"Unknown error\"")
                RETRY_COUNT=$((RETRY_COUNT + 1))
                DELAY=$((2**RETRY_COUNT))
                echo "¬† ‚ö†Ô∏è API call failed: $ERROR_MSG (Attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in $DELAY seconds..."
                sleep "$DELAY"
              fi
            done
                          
            if [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; then
              echo "¬† ‚ùå Failed to generate documentation for iFlow: $IFLOW_NAME after $MAX_RETRIES attempts."
            fi
            echo "=================================================="
          done
                      
          # Set final output status
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      # --- START NEW STEPS FOR PDF GENERATION WITH ACTION ---

      - name: üìÑ Concatenate All iFlow Documents for Single PDF Conversion
        if: steps.documentation_step.outputs.docs_generated == 'true'
        id: concatenate
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # Find all generated Markdown files
          INPUT_FILES=$(find "cpi-artifacts/$PKG_ID" -type f -name '*_Summary.md' | sort)
          
          # Define the single output file for concatenation
          OUTPUT_MD="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.md"
          
          echo "Concatenating files into $OUTPUT_MD"
          
          # Initialize the combined file
          > "$OUTPUT_MD"
          
          # Loop through each generated MD file and append it to the combined file
          for FILE in $INPUT_FILES; do
              IFLOW_NAME=$(basename "$(dirname "$FILE")")
              echo "--- Adding iFlow: $IFLOW_NAME ---"
              
              # Add a visible break before the next document starts, ensuring a new page
              echo "\n<div style=\"page-break-after: always; border-top: 5px solid #1f4e79; margin-top: 50px;\"></div>\n" >> "$OUTPUT_MD"
              cat "$FILE" >> "$OUTPUT_MD"
              
              # Save the location for the new step
              echo "concatenated_file=$OUTPUT_MD" >> $GITHUB_OUTPUT
          done

      - name: üìù Generate Single PDF using GitHub Action
        if: steps.concatenate.outputs.concatenated_file != ''
        id: pdf_action
        uses: actions-js/markdown-to-pdf@v1.0.0
        with:
          # Use the concatenated file from the previous step
          input_path: ${{ steps.concatenate.outputs.concatenated_file }}
          
          # Set the output path to the combined documentation folder
          output_path: ${{ steps.concatenate.outputs.concatenated_file }}.pdf
          
          # Use the same parameters as before for formatting
          page-size: A4
          margin: 0.8in 0.5in 0.8in 0.5in
          
          # Note: This action does not directly support repeatable HTML headers
          # but is highly reliable for core conversion. We rely on the cover page
          # and internal document formatting for branding.

      # --- END NEW STEPS FOR PDF GENERATION WITH ACTION ---

      - name: Commit All Generated Files (MD and PDF)
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
                      
          PKG_ID="${{ github.event.inputs.package_id }}"
          # Commit both Markdown and the new PDF files
          OUTPUT_PATH_MD="cpi-artifacts/$PKG_ID/**/*_Summary.md"
          OUTPUT_PATH_COMBINED_MD="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.md"
          OUTPUT_PATH_PDF="cpi-artifacts/$PKG_ID/Combined_CPI_Documentation.md.pdf"
                      
          git add "$OUTPUT_PATH_MD"
          git add "$OUTPUT_PATH_COMBINED_MD"
          git add "$OUTPUT_PATH_PDF"
                      
          if git diff --cached --quiet "$OUTPUT_PATH_MD" && git diff --cached --quiet "$OUTPUT_PATH_COMBINED_MD" && git diff --cached --quiet "$OUTPUT_PATH_PDF"; then
              echo "No meaningful changes detected in the generated documentation files. Skipping commit."
          else
              git commit -m "ü§ñ DOCS: Generated/Updated iFlow summaries (MD) and Combined PDF for package: $PKG_ID (Action-based conversion)."
              git push
              echo "‚úÖ All documentation and the combined PDF committed and pushed to repository."
          fi
