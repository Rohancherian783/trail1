name: ü§ñ Generate Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          GIT_USER: ${{ github.actor }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # --- SYSTEM PROMPT (unchanged) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following hierarchical 6-point structure..."
          
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) )
          
          if [ -z "$FULL_IFLOW_PATHS" ]; then
              echo "::warning::No iFlows found in package '$PKG_ID'."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi
          
          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")
          
          ALL_DOCS_GENERATED=false
          
          for IFLOW_DIR in $IFLOW_FOLDERS; do
            
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"
            
            echo "=================================================="
            echo "‚û° Processing iFlow: $IFLOW_NAME"
            
            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) )
            
            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "‚ö†Ô∏è No supported artifacts found. Skipping."
                continue
            fi
            
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n$(cat "$INPUT_FILE")\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done
            
            USER_QUERY="Synthesize a single consolidated report following all mandatory sections for iFlow '$IFLOW_NAME'.\n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
            
            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")
              
              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")
              
              if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
                
                echo "  ‚úÖ Documentation generated successfully."
                
                TODAY=$(date +%Y-%m-%d)
                AUTHOR="$GIT_USER"
                VERSION="Draft"
                
                # ------------------------------------------------------------------
                # ‚úî COVER PAGE ADDED HERE (Option A ‚Äî first page)
                # ------------------------------------------------------------------
                COVER_PAGE=$(cat <<EOF
<!-- COVER PAGE START -->

<table style="width:100%;">
<tr>
<td align="left">
  <img src="https://upload.wikimedia.org/wikipedia/commons/5/59/SAP_2011_logo.svg" width="120">
</td>
<td align="right">
  <img src="https://i.ibb.co/8cVbZCy/motiveminds-logo.png" width="150">
</td>
</tr>
</table>

<br><br><br><br>

<h1 align="center" style="color:#1f4e79; font-size:2.8em;">
$IFLOW_NAME ‚Äì Technical Specification Document
</h1>

<br><br><br>

<table style="width:60%; margin-left:auto; margin-right:auto; border-collapse: collapse;" border="1">
<tr>
  <td><strong>Author:</strong></td>
  <td>$AUTHOR</td>
</tr>
<tr>
  <td><strong>Date:</strong></td>
  <td>$TODAY</td>
</tr>
<tr>
  <td><strong>Version:</strong></td>
  <td>$VERSION</td>
</tr>
</table>

<br><br><br><br>

<!-- COVER PAGE END -->

EOF
)

                # --------------------------------------------------------------
                # WRITE FINAL FILE: COVER PAGE FIRST ‚Üí THEN GPT DOCUMENTATION
                # --------------------------------------------------------------
                echo "$COVER_PAGE" > "$OUTPUT_FILE"
                echo "$GENERATED_TEXT" >> "$OUTPUT_FILE"
                
                echo "üíæ Saved documentation to $OUTPUT_FILE"
                
                ALL_DOCS_GENERATED=true
                break
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((2**RETRY_COUNT))
            done
            
            echo "=================================================="
          done
          
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT
          
      - name: Commit All Generated iFlow Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          PKG_ID="${{ github.event.inputs.package_id }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/*_Summary.md"
          
          git add "$OUTPUT_PATH"
          
          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No changes detected."
          else
              git commit -m "ü§ñ DOCS: Generated/Updated individual iFlow summaries with Cover Page"
              git push
              echo "‚úÖ Documentation committed."
          fi







