name: ðŸ¤– Generation Individual iFlow Documentation (Logo & Layout Fix)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc libgbm1 libasound2t64 libnss3 libxss1 libatk-bridge2.0-0 libgtk-3-0
          npm install -g @mermaid-js/mermaid-cli

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          # --- SYSTEM PROMPT (EXACTLY FROM REFERENCE) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your goal is to produce a high-quality, comprehensive Technical Specification Document.
          
          **CRITICAL CONTENT REQUIREMENTS:**
          1. **1.1 Purpose (Expanded):** Analyze the provided XML/Groovy files to explain the business problem.
          2. **1.2 Scope (Expanded):** Detail endpoints, transformations, and constraints.
          3. **2.2 Integration Components:** Identify every adapter, Script step, and Content Modifier.
          4. **3.1 Scenario Description:** Step-by-step walkthrough.
          
          **FORMATTING RULES:**
          - All Headings (H1/H2) MUST use color '${{ env.HEADING_COLOR }}' and be left-aligned.
          - Subheadings wrapped in: <b style=\"color: ${{ env.HEADING_COLOR }};\">...</b> followed by a NEW LINE.
          - **IMPORTANT:** For section 2.1, provide a valid Mermaid.js graph starting with \`\`\`mermaid and ending with \`\`\`.

          **REQUIRED STRUCTURE:**
          <h1 style=\"color: ${{ env.HEADING_COLOR }}; font-size: 2.5em; text-align: left;\">Table of Contents</h1>
          1. Introduction <br>
          &nbsp;&nbsp;&nbsp; 1.1 Purpose <br>
          &nbsp;&nbsp;&nbsp; 1.2 Scope <br>
          2. Integration Overview <br>
          &nbsp;&nbsp;&nbsp; 2.1 Integration Architecture <br>
          &nbsp;&nbsp;&nbsp; 2.2 Integration Components <br>
          3. Integration Scenarios <br>
          &nbsp;&nbsp;&nbsp; 3.1 Scenario Description <br>
          &nbsp;&nbsp;&nbsp; 3.2 Data Flows <br>
          &nbsp;&nbsp;&nbsp; 3.3 Security Requirements <br>
          4. Error Handling and Logging <br>
          5. Testing Validation <br>
          6. Reference Documents <br>
          ---TOC-END-PAGE-BREAK---"

          ALL_DOCS_GENERATED=false
          while IFS= read -r IFLOW_DIR; do
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            FINAL_IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_ROOT_NAME"
            OUTPUT_DOCX="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Technical_Specification.docx"
            
            AUTHOR=$(git log -1 --pretty=format:'%an')
            DATE=$(date +'%Y-%m-%d')
            EXTRACTED_VERSION=$(grep -rPho '(?<=<Version>)[^<]+' "$IFLOW_DIR" | head -n 1)
            IFLOW_VERSION=${EXTRACTED_VERSION:-"1.0.0"}

            # Setup Logo Assets
            SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
            MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
            
            # Create a simple Header Table (SAP Left, MM Right)
            # We use a temp file to store this to avoid shell escaping issues
            echo "| ![]($SAP_LOGO){width=100px} | | <p align='right'>![]($MM_LOGO){width=130px}</p> |" > header.txt
            echo "|:---|:---:|---:|" >> header.txt
            echo "" >> header.txt
            HEADER_CONTENT=$(cat header.txt)

            QUERY_FILE="user_query.tmp"
            find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -exec cat {} + > "$QUERY_FILE"
            
            PAYLOAD_FILE="payload.json"
            jq -n --arg system "$SYSTEM_PROMPT" --rawfile query "$QUERY_FILE" --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}' > "$PAYLOAD_FILE"
            
            API_RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d @"$PAYLOAD_FILE")
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content // empty")
            
            if [ -n "$GENERATED_TEXT" ]; then
              # 1. Mermaid Rendering
              echo "$GENERATED_TEXT" | sed -n '/```mermaid/,/```/p' | sed 's/```mermaid//g; s/```//g' > architecture.mmd
              if [ -s architecture.mmd ]; then
                echo '{"args": ["--no-sandbox", "--disable-setuid-sandbox"]}' > puppeteer_config.json
                mmdc -p puppeteer_config.json -i architecture.mmd -o architecture.png -b transparent
                GENERATED_TEXT=$(perl -0777 -pe 's/```mermaid.*?```/![Integration Architecture](architecture.png)/sg' <<< "$GENERATED_TEXT")
              fi

              # 2. Cover Page Generation
              {
                cat header.txt
                echo -e "\n\n<br><br>\n\n# <center><span style='color: ${{ env.HEADING_COLOR }}'>$IFLOW_ROOT_NAME</span></center>\n"
                echo -e "### <center>Technical Specification Document</center>\n\n<br><br>\n"
                echo "| | |"
                echo "|:---|:---|"
                echo "| **Author** | $AUTHOR |"
                echo "| **Date** | $DATE |"
                echo "| **Version** | $IFLOW_VERSION |"
                echo -e "\n\pagebreak\n"
              } > full_doc.md

              # 3. Add Content with Header Injections
              # Instead of complex regex, we use a simple loop or multi-step sed
              TOC_TRANSITION="\pagebreak\n\n$HEADER_CONTENT\n\n"
              
              # Safely replace TOC marker and inject headers before H1 tags
              echo "$GENERATED_TEXT" | \
              perl -0777 -pe "s|---TOC-END-PAGE-BREAK---|\\pagebreak\n\n|g" | \
              perl -0777 -pe "s|<h1|$HEADER_CONTENT\n<h1|g" >> full_doc.md

              # 4. Final Render
              pandoc full_doc.md -o "$OUTPUT_DOCX"
              
              rm -f full_doc.md header.txt architecture.mmd architecture.png puppeteer_config.json "$QUERY_FILE" "$PAYLOAD_FILE"
              ALL_DOCS_GENERATED=true
            fi
          done < <(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u)
          
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "cpi-artifacts/${{ github.event.inputs.package_id }}/**/*.docx"
          git commit -m "ðŸ¤– DOCS: Logos on every page and fixed cover page layout"
          git push


