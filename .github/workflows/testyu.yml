name: ðŸ¤– CPI Generation Documentation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc python3-pip
          pip3 install weasyprint

      - name: Generate Individual iFlow Documentation
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found at: $BASE_PKG_DIR"
            exit 1
          fi

          # --- SYSTEM PROMPT: ENFORCING NEW LINES & PROFESSIONAL DEPTH ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. 
          **FORMATTING REQUIREMENTS:**
          1. Headings (H1/H2) and Subheadings (1.1, 2.1 etc) MUST use color '${{ env.HEADING_COLOR }}'.
          2. Subheadings MUST be: <b style=\"color: ${{ env.HEADING_COLOR }};\">...</b>.
          3. **NEW LINE MANDATE:** For 1.1 Purpose and 1.2 Scope, the descriptive content MUST begin on a new line. 
          4. **ARCHITECTURE:** Use Mermaid 'graph TD' for section 2.1.
          5. **DETAIL:** Provide high-quality, multi-paragraph technical explanations for Purpose and Scope.

          **REQUIRED STRUCTURE:**
          <h1 style=\"color: ${{ env.HEADING_COLOR }};\">Table of Contents</h1>
          1. Introduction <br>
          &nbsp;&nbsp;&nbsp; 1.1 Purpose <br>
          &nbsp;&nbsp;&nbsp; 1.2 Scope <br>
          2. Integration Overview <br>
          &nbsp;&nbsp;&nbsp; 2.1 Integration Architecture <br>
          &nbsp;&nbsp;&nbsp; 2.2 Integration Components <br>
          3. Integration Scenarios <br>
          &nbsp;&nbsp;&nbsp; 3.1 Scenario Description <br>
          &nbsp;&nbsp;&nbsp; 3.2 Data Flows <br>
          &nbsp;&nbsp;&nbsp; 3.3 Security Requirements <br>
          4. Error Handling and Logging <br>
          5. Testing Validation <br>
          6. Reference Documents <br>
          ---TOC-END-PAGE-BREAK---"

          ALL_DOCS_GENERATED=false
          while IFS= read -r IFLOW_DIR; do
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            FINAL_IFLOW_DIR="$BASE_PKG_DIR/$IFLOW_ROOT_NAME"
            OUTPUT_MD="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Summary.md"
            OUTPUT_PDF="$FINAL_IFLOW_DIR/${IFLOW_ROOT_NAME}_Technical_Spec.pdf"

            EXTRACTED_VERSION=$(grep -rPho '(?<=<Version>)[^<]+' "$IFLOW_DIR" | head -n 1)
            IFLOW_VERSION=${EXTRACTED_VERSION:-"1.0.0"}

            QUERY_FILE="user_query.tmp"
            echo "Analyze iFlow artifacts for '$IFLOW_ROOT_NAME':" > "$QUERY_FILE"
            find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -exec sh -c 'echo "--- ARTIFACT: {} ---"; cat {}' \; >> "$QUERY_FILE"

            PAYLOAD_FILE="payload.json"
            jq -n --arg system "$SYSTEM_PROMPT" --rawfile query "$QUERY_FILE" --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}' > "$PAYLOAD_FILE"
            
            API_RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d @"$PAYLOAD_FILE")
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content // empty")

            if [ -n "$GENERATED_TEXT" ] && [ "$GENERATED_TEXT" != "null" ]; then
              CLEANED_TEXT=$(echo -e "$GENERATED_TEXT" | sed -E '1s/^\s*```(markdown|text)?//' | sed -E '$s/\s*```\s*$//')
              
              AUTHOR=$(git log -1 --pretty=format:'%an')
              DATE=$(date +'%Y-%m-%d')
              SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
              MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
              
              # PROFESSIONAL STYLING FOR PDF
              STYLE="<style> @page { margin: 2.5cm; } body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; } 
                     h1, h2 { border-bottom: 1px solid #ddd; padding-bottom: 5px; } 
                     table { width: 100%; border-collapse: collapse; margin: 20px 0; } 
                     th, td { border: 1px solid #ccc; padding: 12px; text-align: left; } 
                     th { background-color: #f9f9f9; } </style>"

              LOGO_HEADER="<div style='display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid ${{ env.HEADING_COLOR }}; padding-bottom: 10px; margin-bottom: 30px;'><img src='$SAP_LOGO' height='50'/><img src='$MM_LOGO' height='45'/></div>"

              # COVER PAGE
              COVER="<div style='text-align: center; padding-top: 50px;'>$LOGO_HEADER<h1 style='color: ${{ env.HEADING_COLOR }}; font-size: 3em; margin: 80px 0 20px 0; border:none;'>$(echo $IFLOW_ROOT_NAME | sed 's/_/ /g')</h1>"
              COVER+="<h2 style='border:none;'>Technical Specification Document</h2>"
              COVER+="<div style='margin-top: 100px;'><table style='width: 400px; margin: 0 auto;'>"
              COVER+="<tr><th>Author</th><td>$AUTHOR</td></tr><tr><th>Date</th><td>$DATE</td></tr><tr><th>Version</th><td>$IFLOW_VERSION</td></tr></table></div></div>"

              # ASSEMBLY
              FINAL_HTML="${STYLE}${COVER}<div style='page-break-after: always;'></div>${LOGO_HEADER}${CLEANED_TEXT}"
              FINAL_HTML=$(echo -e "$FINAL_HTML" | sed "s|---TOC-END-PAGE-BREAK---|</div><div style='page-break-before: always;'>${LOGO_HEADER}|g")
              
              echo -e "$FINAL_HTML" > "$OUTPUT_MD"
              pandoc "$OUTPUT_MD" -o "$OUTPUT_PDF" --pdf-engine=weasyprint
              
              ALL_DOCS_GENERATED=true
            fi
            rm -f "$QUERY_FILE" "$PAYLOAD_FILE"
          done < <(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u)
          
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          PKG_ID="${{ github.event.inputs.package_id }}"
          git add "cpi-artifacts/$PKG_ID/**/*"
          git commit -m "ðŸ¤– DOCS: High-quality PDF with margins and professional styling for $PKG_ID"
          git push




