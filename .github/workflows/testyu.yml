name: ðŸ¤– CPIGeneration  Documentation
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install weasyprint

      - name: Generate Technical Documentation
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. 
          **FORMATTING RULES:**
          1. Use ONLY HTML tags.
          2. **CLICKABLE TOC:** Every item in the Table of Contents must be a link: <a href='#id' style='text-decoration:none; color:black;'>Section Name</a>.
          3. **ANCHORS:** Every heading in the document must have a matching ID: <h2 id='id' style='color: ${{ env.HEADING_COLOR }};'>...</h2>.
          4. **REQUIRED CONTENT:** Provide detailed technical descriptions for sections 1.1 through 6.0.

          **TOC TEMPLATE (MUST BE CLICKABLE):**
          <h2 id='toc' style='color: ${{ env.HEADING_COLOR }};'>Table of Contents</h2>
          <ul style='list-style: none; padding-left: 0; line-height: 2;'>
            <li><b><a href='#sec1' style='text-decoration:none; color:inherit;'>1. Introduction</a></b></li>
            <li style='padding-left: 20px;'><a href='#sec1_1' style='text-decoration:none; color:inherit;'>1.1 Purpose</a></li>
            <li style='padding-left: 20px;'><a href='#sec1_2' style='text-decoration:none; color:inherit;'>1.2 Scope</a></li>
            <li><b><a href='#sec2' style='text-decoration:none; color:inherit;'>2. Integration Overview</a></b></li>
            <li style='padding-left: 20px;'><a href='#sec2_1' style='text-decoration:none; color:inherit;'>2.1 Integration Architecture</a></li>
            <li style='padding-left: 20px;'><a href='#sec2_2' style='text-decoration:none; color:inherit;'>2.2 Integration Components</a></li>
            <li><b><a href='#sec3' style='text-decoration:none; color:inherit;'>3. Integration Scenarios</a></b></li>
            <li style='padding-left: 20px;'><a href='#sec3_3' style='text-decoration:none; color:inherit;'>3.3 Security Requirements</a></li>
          </ul>
          <div style='page-break-after: always;'></div>"

          ALL_DOCS_GENERATED=false
          while IFS= read -r IFLOW_DIR; do
            IFLOW_ROOT_NAME=$(echo "$IFLOW_DIR" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1)
            OUTPUT_PDF="$BASE_PKG_DIR/$IFLOW_ROOT_NAME/${IFLOW_ROOT_NAME}_Technical_Spec.pdf"
            EXTRACTED_VERSION=$(grep -rPho '(?<=<Version>)[^<]+' "$IFLOW_DIR" | head -n 1)
            IFLOW_VERSION=${EXTRACTED_VERSION:-"1.0.0"}

            QUERY_FILE="user_query.tmp"
            find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -exec sh -c 'echo "FILE: {}"; cat {}' \; >> "$QUERY_FILE"

            PAYLOAD_FILE="payload.json"
            jq -n --arg system "$SYSTEM_PROMPT" --rawfile query "$QUERY_FILE" --arg model "$MODEL_NAME" \
              '{model: $model, messages: [{role: "system", content: $system}, {role: "user", content: $query}], temperature: 0.1}' > "$PAYLOAD_FILE"
            
            API_RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d @"$PAYLOAD_FILE")
            GENERATED_HTML=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content // empty" | sed -E '1s/^\s*```(html)?//' | sed -E '$s/\s*```\s*$//')

            if [ -n "$GENERATED_HTML" ]; then
              SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
              MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
              AUTHOR=$(git log -1 --pretty=format:'%an')
              
              STYLE="<style>
                @page { 
                  size: A4; margin: 4.5cm 2cm 2.5cm 2cm; 
                  @top-center { content: element(header); }
                  @bottom-right { content: 'Page ' counter(page); font-size: 10pt; }
                }
                #header { position: running(header); width: 100%; border-bottom: 2px solid ${{ env.HEADING_COLOR }}; }
                .logo-table { width: 100%; border: none !important; }
                .logo-table td { border: none !important; padding: 0; vertical-align: middle; }
                body { font-family: 'Helvetica', Arial, sans-serif; font-size: 11pt; line-height: 1.6; color: #333; }
                h2, h3 { color: ${{ env.HEADING_COLOR }}; margin-top: 1.5em; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                th { background-color: #f8f9fa; }
                .cover { text-align: center; page-break-after: always; padding-top: 4cm; }
              </style>"

              HEADER_HTML="<div id='header'>
                <table class='logo-table'>
                  <tr>
                    <td style='text-align: left;'><img src='$SAP_LOGO' style='height: 80px;'></td>
                    <td style='text-align: right;'><img src='$MM_LOGO' style='height: 65px;'></td>
                  </tr>
                </table>
              </div>"

              COVER="<div class='cover'>
                <h1 style='font-size: 34pt; color: ${{ env.HEADING_COLOR }};'>$(echo $IFLOW_ROOT_NAME | sed 's/_/ /g')</h1>
                <p style='font-size: 18pt;'>Technical Specification Document</p>
                <table style='width: 380px; margin: 80px auto;'>
                  <tr><th>Author</th><td>$AUTHOR</td></tr>
                  <tr><th>Date</th><td>$(date +'%Y-%m-%d')</td></tr>
                  <tr><th>Version</th><td>$IFLOW_VERSION</td></tr>
                </table>
              </div>"

              echo "${STYLE}${HEADER_HTML}${COVER}${GENERATED_HTML}" > final.html
              weasyprint final.html "$OUTPUT_PDF"
              ALL_DOCS_GENERATED=true
            fi
            rm -f "$QUERY_FILE" "$PAYLOAD_FILE" final.html
          done < <(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u)
          
          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "cpi-artifacts/**/*.pdf"
          git commit -m "ðŸ¤– DOCS: Clickable TOC and Forced Left/Right Logos"
          git push




