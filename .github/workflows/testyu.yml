name: ðŸ¤– CPI Documentation Generation (MD â†’ DOCX)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "CPI Package ID (folder under cpi-artifacts/)"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # ------------------------------------------------------------
    # Checkout repository
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4


    # ------------------------------------------------------------
    # Install dependencies (pandoc, mermaid-cli, python-docx)
    # ------------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq pandoc python3 python3-pip nodejs npm wget
        sudo npm install -g @mermaid-js/mermaid-cli
        python3 -m pip install --upgrade pip
        python3 -m pip install python-docx requests


    # ------------------------------------------------------------
    # Create Python converter script (YAML-safe heredoc)
    # ------------------------------------------------------------
    - name: Create md_to_docx.py
      run: |
        mkdir -p .github/scripts

        cat << 'PY' > .github/scripts/md_to_docx.py
#!/usr/bin/env python3
import sys
import re
import subprocess
import requests
from pathlib import Path
from docx import Document
from docx.shared import Inches

def download(url, dest):
    r = requests.get(url, timeout=20)
    r.raise_for_status()
    with open(dest, "wb") as f:
        f.write(r.content)

def convert_mermaid(md_path):
    content = md_path.read_text(encoding="utf-8")
    pattern = re.compile(r"```mermaid\s*(.*?)```", re.DOTALL)
    matches = pattern.findall(content)
    if not matches:
        return

    assets = md_path.parent / (md_path.stem + "_assets")
    assets.mkdir(exist_ok=True)

    for i, code in enumerate(matches, start=1):
        mmd = assets / f"diagram_{i}.mmd"
        png = assets / f"diagram_{i}.png"
        mmd.write_text(code.strip(), encoding="utf-8")
        subprocess.run(["mmdc", "-i", str(mmd), "-o", str(png)], check=True)
        content = content.replace(f"```mermaid\n{code}```", f"![Diagram]({png.name})")

    md_path.write_text(content, encoding="utf-8")

def md_to_docx(md_path, docx_path, sap_url, mm_url):
    convert_mermaid(md_path)

    # Download logos
    sap_file = md_path.parent / "sap_logo.png"
    mm_file = md_path.parent / "mm_logo.png"
    download(sap_url, sap_file)
    download(mm_url, mm_file)

    # Convert mdâ†’docx with pandoc
    subprocess.run(["pandoc", str(md_path), "-o", str(docx_path)], check=True)

    # Add headers with logos
    doc = Document(str(docx_path))
    section = doc.sections[0]
    header = section.header
    table = header.add_table(rows=1, cols=2)

    left_run = table.rows[0].cells[0].paragraphs[0].add_run()
    left_run.add_picture(str(sap_file), width=Inches(1.5))

    right_para = table.rows[0].cells[1].paragraphs[0]
    try:
        from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
        right_para.alignment = WD_PARAGRAPH_ALIGNMENT.RIGHT
    except:
        pass
    right_run = right_para.add_run()
    right_run.add_picture(str(mm_file), width=Inches(1.5))

    doc.save(str(docx_path))

if __name__ == "__main__":
    md = Path(sys.argv[1]).resolve()
    docx = Path(sys.argv[2]).resolve()
    sap = sys.argv[3]
    mm = sys.argv[4]
    md_to_docx(md, docx, sap, mm)
PY

        chmod +x .github/scripts/md_to_docx.py


    # ------------------------------------------------------------
    # Generate Markdown using OpenAI, then convert to DOCX
    # ------------------------------------------------------------
    - name: Generate Documentation
      id: docs
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PKG: ${{ github.event.inputs.package_id }}
        SAP_LOGO: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
        MM_LOGO: "https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"
      run: |
        set -euo pipefail

        BASE="cpi-artifacts/${PKG}"
        API="https://api.openai.com/v1/chat/completions"
        MODEL="gpt-4o-mini"

        if [ ! -d "$BASE" ]; then
          echo "::error::Package not found: $BASE"
          echo "docs_generated=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        # System prompt saved safely
        cat << 'EOF' > /tmp/system_prompt.txt
Generate structured CPI technical documentation in Markdown.
Include:
- Table of Contents
- Sectioned technical documentation
- Mermaid diagrams in section 2.1 when applicable
EOF

        # Identify iFlow folders
        IFS=$'\n'
        IFLOWS=$(find "$BASE" -maxdepth 2 -type f -name "iFlowContent.xml" | sed "s|$BASE/||" | cut -d/ -f1 | sort -u)

        ANY=false

        for F in $IFLOWS; do
          DIR="$BASE/$F"
          MD="$DIR/${F}_Summary.md"
          DOCX="$DIR/${F}_Summary.docx"

          echo "Processing iFlow: $F"

          CONTENT=""
          for file in $(find "$DIR" -type f \( -name "*.xml" -o -name "*.groovy" -o -name "*.xslt" -o -name "*.iflw" \)); do
            CONTENT="$CONTENT\n\n--- FILE: $file ---\n$(cat "$file")\n"
          done

          USER_QUERY="Create CPI documentation for iFlow: ${F}.
\`\`\`text
${CONTENT}
\`\`\`"

          # Build payload
          PAYLOAD=$(jq -n \
            --arg sys "$(cat /tmp/system_prompt.txt)" \
            --arg usr "$USER_QUERY" \
            --arg model "$MODEL" \
            '{model:$model, messages:[{role:"system",content:$sys},{role:"user",content:$usr}]}' )

          # Call OpenAI
          RES=$(curl -s -X POST "$API" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          TEXT=$(echo "$RES" | jq -r '.choices[0].message.content // empty')

          if [ -z "$TEXT" ]; then
            echo "::warning::OpenAI returned no text for $F"
            continue
          fi

          echo -e "$TEXT" > "$MD"
          echo "Saved MD â†’ $MD"

          # Convert to DOCX
          python3 .github/scripts/md_to_docx.py "$MD" "$DOCX" "$SAP_LOGO" "$MM_LOGO"

          if [ -f "$DOCX" ]; then
            echo "Created DOCX â†’ $DOCX"
            ANY=true
          fi
        done

        echo "docs_generated=$ANY" >> $GITHUB_OUTPUT


    # ------------------------------------------------------------
    # Commit MD + DOCX
    # ------------------------------------------------------------
    - name: Commit generated files
      if: steps.docs.outputs.docs_generated == 'true'
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add cpi-artifacts/**/*_Summary.md || true
        git add cpi-artifacts/**/*_Summary.docx || true

        if git diff --cached --quiet; then
          echo "No new changes to commit."
        else
          git commit -m "ðŸ¤– Auto-generated CPI documentation (MD + DOCX)"
          git push
        fi



