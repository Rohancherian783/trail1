name: Docs Only - Fetch CPI, Analyze, and Commit Summary
 
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package to Fetch, Document, and Commit (Summary Only)."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
 
      - name: üåê Flashpipe Fetch (CPI to Temporary cpi-artifacts)
        id: fetch_cpi_artifacts
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          CPI_URL: ${{ secrets.CPI_URL }}
          CPI_USERNAME: ${{ secrets.CPI_USERNAME }}
          CPI_PASSWORD: ${{ secrets.CPI_PASSWORD }}
        run: |
          # --- Paths ---
          CODE_DIR="cpi-artifacts/$PKG_ID"
          
          echo "--- Running Flashpipe to pull $PKG_ID into $CODE_DIR ---"
          
          # --------------------------------------------------------------------------
          # ACTION REQUIRED: Replace the lines below with your actual Flashpipe command.
          # Example: flashpipe pull package --package-id $PKG_ID --target-dir $CODE_DIR --force
          # --------------------------------------------------------------------------
          
          # --- MOCK FILES FOR TESTING (DELETE THIS SECTION IN PRODUCTION) ---
          MOCK_DIR="$CODE_DIR/TestIFlow"
          mkdir -p "$MOCK_DIR"
          echo "<IntegrationFlow name='Test Flow 1'><description>A test flow</description></IntegrationFlow>" > "$MOCK_DIR/iFlowContent.xml"
          echo "def msg = message.getBody(); return 'Modified: ' + msg;" > "$CODE_DIR/my_utility_script.groovy"
          # --- END MOCK FILES ---
          
          if [ ! -d "$CODE_DIR" ]; then
            echo "::error::Package directory was not created by Flashpipe. Check Flashpipe command."
            exit 1
          fi

      - name: üß† Analyze and Generate Consolidated Summary
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} 
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Paths ---
          CODE_DIR="cpi-artifacts/$PKG_ID"        # Source of CPI files
          DOCS_DIR="Documentation/$PKG_ID"        # Destination for the summary
          OUTPUT_FILE="$DOCS_DIR/Package_Summary.md" 
          
          # Create the required destination folder structure
          mkdir -p "$DOCS_DIR"
          
          # --- SYSTEM PROMPT (Strict 10-Point Structure) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from a single CPI package and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure: 1. High-level architecture, 2. Purpose of each iFlow, 3. Sender/Receiver systems, 4. Adapter types used, 5. Step-by-step flow explanation, 6. Mapping logic summary, 7. Groovy script explanations, 8. Error handling, 9. Security/authentication, 10. Deployment notes."

          # --- Data Consolidation (Reads from CODE_DIR) ---
          FULL_ARTIFACT_CONTENT=""
          FILES_TO_ANALYZE=$(find "$CODE_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \) -print)

          if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "::warning::No supported artifacts found in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi

          for INPUT_FILE in $FILES_TO_ANALYZE; do
            FILE_CONTENT=$(cat "$INPUT_FILE")
            FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
            FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
            FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
          done
          
          USER_QUERY="Synthesize a single, consolidated technical report following the 10 mandatory sections from the entire set of package artifacts provided below. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
          
          # --- API Execution ---
          PAYLOAD=$(jq -n --arg system "$SYSTEM_PROMPT" --arg query "$USER_QUERY" --arg model "gpt-4o-mini" \
            '{ model: $model, messages: [{role: "system", content: $system},{role: "user", content: $query}], temperature: 0.1 }')
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            API_RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d "$PAYLOAD")
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

            if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
              echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
              echo "docs_generated=true" >> $GITHUB_OUTPUT
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((2**RETRY_COUNT))
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "docs_generated=false" >> $GITHUB_OUTPUT
          fi
          
 
      - name: üíæ Commit Documentation Summary (Only Documentation Folder)
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Add ONLY the Documentation folder
          git add --force "Documentation"
          
          if git diff --cached --quiet; then
              echo "No changes detected in the documentation summary. Skipping commit."
          else
              PKG_ID="${{ github.event.inputs.package_id }}"
              git commit -m "ü§ñ DOCS: Generated and updated Package Summary for $PKG_ID in Documentation/ folder."
              git push
              echo "‚úÖ Documentation committed to repository."
          fi
