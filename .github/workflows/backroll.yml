name: Restore Full History of a CPI Package
 
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the package whose full history you want to restore (e.g., 'TEST_PACKAGE')."
        required: true
        type: string
 
jobs:
  restore:
    runs-on: ubuntu-latest
    container:
      image: engswee/flashpipe:latest
 
    steps:
      - name: Checkout repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          # Fix for the ownership issue inside the container
          persist-credentials: true
 
      - name: Configure Git Safe Directory
        run: |
          # This resolves the 'detected dubious ownership' error from the previous run.
          git config --global --add safe.directory /__w/trail1/trail1
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
 
      - name: Find and Order Historical Commits
        id: commits
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          echo "ðŸ” Searching for historical sync commits for package: $PKG_ID"
          
          PACKAGE_PATH="cpi-artifacts/$PKG_ID"

          # CRITICAL FIX: Searching for the exact user-defined commit message: "Sync repo from tenant"
          # This finds all commits that modified the package path and have the sync message, 
          # sorted from oldest to newest.
          COMMITS_LIST=$(git log --pretty=format:'%H' --reverse --grep "Sync repo from tenant" -- "$PACKAGE_PATH")

          if [ -z "$COMMITS_LIST" ]; then
            echo "::error::No historical sync commits found for package '$PKG_ID'."
            echo "::warning::Make sure your sync job committed with the exact message: 'Sync repo from tenant'"
            echo "::warning::Checking package path: $PACKAGE_PATH"
            exit 1
          fi
          
          echo "âœ… Found historical commits (oldest to newest): $COMMITS_LIST"
          echo "commit_hashes=$COMMITS_LIST" >> $GITHUB_OUTPUT
 
      - name: Loop and Deploy Each Historical Version
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          COMMITS_TO_DEPLOY: ${{ steps.commits.outputs.commit_hashes }}
        
        run: |
          PACKAGE_DIR="cpi-artifacts/$PKG_ID"
          EXIT_CODE=0
          
          for COMMIT_HASH in $COMMITS_TO_DEPLOY; do
            echo "=========================================================="
            echo "âž¡ RESTORING HASH $COMMIT_HASH: Deploying content to CPI."
            
            # 1. Restore the historical files from the commit into the working directory
            # The '--' ensures only the files in this directory are checked out.
            git checkout $COMMIT_HASH -- "$PACKAGE_DIR"

            if [ ! -d "$PACKAGE_DIR" ]; then
              echo "::error::Package directory $PACKAGE_DIR not found in commit $COMMIT_HASH. Skipping."
              continue
            fi
            
            # 2. Deployment using FlashPipe
            flashpipe sync \
              --tmn-host "$TMN_HOST" \
              --oauth-host "$OAUTH_HOST" \
              --oauth-clientid "$CLIENT_ID" \
              --oauth-clientsecret "$CLIENT_SECRET" \
              --package-id "$PKG_ID" \
              --dir-artifacts "$PACKAGE_DIR" \
              --sync-package-details \
              --target "tenant"
              
            if [ $? -ne 0 ]; then
                echo "::error::Deployment FAILED for hash $COMMIT_HASH. Stopping history restoration."
                EXIT_CODE=1
                break
            fi
            
            # 3. Clean up the checkout before the next loop iteration (Important!)
            # This ensures the next checkout starts from a clean HEAD state.
            git checkout HEAD -- "$PACKAGE_DIR"
            echo "âœ… Deployment SUCCESSFUL. CPI should now show the next sequential version."
          done
          
          exit $EXIT_CODE
