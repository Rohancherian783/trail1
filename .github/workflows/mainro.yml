name: Docs Only - Fetch CPI Documentation
 
on:
  # This allows manual triggering from the GitHub Actions tab, requiring the package_id input.
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package to Fetch, Document, and Commit (Summary Only)."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    # Using the Flashpipe container ensures the 'flashpipe' command is available.
    container:
      image: engswee/flashpipe:latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Dependencies (jq only)
        # jq is necessary to build the JSON payload for the OpenAI API call.
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
 
      - name: ðŸŒ Flashpipe Fetch (CPI to Temporary cpi-artifacts)
        id: fetch_cpi_artifacts
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          # ðŸš¨ NEW: Standardizing on OAuth secrets for consistency and security ðŸš¨
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          
        run: |
          # The directory where the artifacts will be temporarily stored for analysis
          CODE_DIR="cpi-artifacts/$PKG_ID"
          
          echo "--- Running Flashpipe to pull $PKG_ID into $CODE_DIR ---"
          
          # =========================================================================
          # 1. Configure Flashpipe credentials using OAuth/Client Credentials
          # =========================================================================
          flashpipe config set credentials \
            --tmn-host "$TMN_HOST" \
            --oauth-host "$OAUTH_HOST" \
            --oauth-clientid "$CLIENT_ID" \
            --oauth-clientsecret "$CLIENT_SECRET"

          # =========================================================================
          # 2. Pull the actual CPI package content using 'sync' targeting 'git'
          #    This command pulls the data from CPI (Tenant) to the directory (Git).
          # =========================================================================
          flashpipe sync \
            --package-id "$PKG_ID" \
            --dir-artifacts "$CODE_DIR" \
            --sync-package-details \
            --target "git" 
          
          
          if [ ! -d "$CODE_DIR" ]; then
            echo "::error::Package directory was not created by Flashpipe. Check Package ID or CPI connection secrets."
            exit 1
          fi

      - name: ðŸ§  Analyze and Generate Consolidated Summary
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} 
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Paths ---
          CODE_DIR="cpi-artifacts/$PKG_ID"        # Source of CPI files
          DOCS_DIR="Documentation/$PKG_ID"        # Destination for the summary
          OUTPUT_FILE="$DOCS_DIR/Package_Summary.md" 
          
          # Create the required destination folder structure
          mkdir -p "$DOCS_DIR"
          
          # --- SYSTEM PROMPT (Strict 10-Point Structure) ---
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from a single CPI package and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure: 1. High-level architecture, 2. Purpose of each iFlow, 3. Sender/Receiver systems, 4. Adapter types used, 5. Step-by-step flow explanation, 6. Mapping logic summary, 7. Groovy script explanations, 8. Error handling, 9. Security/authentication, 10. Deployment notes."

          # --- Data Consolidation (Reads from CODE_DIR) ---
          FULL_ARTIFACT_CONTENT=""
          FILES_TO_ANALYZE=$(find "$CODE_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \) -print)

          if [ -z "$FILES_TO_ANALYZE" ]; then
              echo "::warning::No supported artifacts found in package '$PKG_ID'. Skipping documentation."
              echo "docs_generated=false" >> $GITHUB_OUTPUT
              exit 0
          fi

          for INPUT_FILE in $FILES_TO_ANALYZE; do
            FILE_CONTENT=$(cat "$INPUT_FILE")
            FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
            FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
            FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
          done
          
          USER_QUERY="Synthesize a single, consolidated technical report following the 10 mandatory sections from the entire set of package artifacts provided below. \n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"
          
          # --- API Execution ---
          PAYLOAD=$(jq -n --arg system "$SYSTEM_PROMPT" --arg query "$USER_QUERY" --arg model "gpt-4o-mini" \
            '{ model: $model, messages: [{role: "system", content: $system},{role: "user", content: $query}], temperature: 0.1 }')
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            API_RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" -H "Content-Type: application/json" -H "Authorization: Bearer $OPENAI_API_KEY" -d "$PAYLOAD")
            GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

            if [ "$GENERATED_TEXT" != "null" ] && [ -n "$GENERATED_TEXT" ]; then
              echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
              echo "docs_generated=true" >> $GITHUB_OUTPUT
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((2**RETRY_COUNT))
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "docs_generated=false" >> $GITHUB_OUTPUT
          fi
          
 
      - name: ðŸ’¾ Commit Documentation Summary (Only Documentation Folder)
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Add ONLY the Documentation folder to the commit index
          git add --force "Documentation"
          
          # Check if the generated documentation actually changed anything
          if git diff --cached --quiet; then
              echo "No changes detected in the documentation summary. Skipping commit."
          else
              PKG_ID="${{ github.event.inputs.package_id }}"
              git commit -m "ðŸ¤– DOCS: Generated and updated Package Summary for $PKG_ID in Documentation/ folder."
              git push
              echo "âœ… Documentation committed to repository."
          fi
