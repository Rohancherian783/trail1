name:  Single-Click Restore ALL Package Histories
 
on:
  # This triggers the workflow with a single click and requires no manual inputs.
  workflow_dispatch:
 
jobs:
  mass_restore:
    runs-on: ubuntu-latest
    container:
      image: engswee/flashpipe:latest
 
    steps:
      - name: Checkout repository (Full History)
        uses: actions/checkout@v4
        with:
          # Crucial: fetch all history for git log
          fetch-depth: 0 
          persist-credentials: true
 
      - name: Configure Git Safe Directory
        run: |
          # Resolves the 'dubious ownership' error inside the container environment.
          git config --global --add safe.directory /__w/trail1/trail1
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
 
      - name: Discover ALL Packages for Restoration
        id: discovery
        run: |
          # Finds all subdirectories immediately under cpi-artifacts/ and lists them separated by spaces.
          PKGS_TO_RESTORE=$(find cpi-artifacts -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | tr '\n' ' ')
          
          if [ -z "$PKGS_TO_RESTORE" ]; then
            echo "::warning::No package directories found in cpi-artifacts. Nothing to restore."
            exit 0
          fi
          
          echo "✅ Packages identified for mass restoration: $PKGS_TO_RESTORE"
          # Pass the space-separated list of IDs to the next step
          echo "packages=$PKGS_TO_RESTORE" >> $GITHUB_OUTPUT
 
      - name: Execute Sequential Deployment for ALL Packages
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          ALL_PKGS: ${{ steps.discovery.outputs.packages }}
          COMMIT_MESSAGE: "Sync repo from tenant" # Your specific commit message
        
        run: |
          EXIT_CODE=0
          
          # Outer loop: Iterate over every package found in the repository
          for PKG_ID in $ALL_PKGS; do
            echo "=========================================================="
            echo "STARTING HISTORY RESTORATION FOR PACKAGE: $PKG_ID"
            
            PACKAGE_DIR="cpi-artifacts/$PKG_ID"
            
            # 1. Find the historical commits for THIS specific package
            COMMITS_LIST=$(git log --pretty=format:'%H' --reverse --grep "$COMMIT_MESSAGE" -- "$PACKAGE_DIR" | tr '\n' ' ')

            if [ -z "$COMMITS_LIST" ]; then
                echo "::warning::No historical commits found for '$PKG_ID' matching the message '$COMMIT_MESSAGE'. Skipping package."
                continue
            fi
            
            echo "   Found sequential commits: $COMMITS_LIST"
            
            # Inner loop: Deploy each historical commit in order (oldest to newest)
            for COMMIT_HASH in $COMMITS_LIST; do
              echo "   ➡ Deploying Hash $COMMIT_HASH content as new CPI version."
              
              # a. Restore the historical files from the commit into the working directory
              # Note: We must use the 'git checkout <hash> -- <path>' syntax for safety
              git checkout $COMMIT_HASH -- "$PACKAGE_DIR"

              if [ ! -d "$PACKAGE_DIR" ]; then
                echo "::error::Package directory $PACKAGE_DIR not found in commit $COMMIT_HASH. Something is wrong with the history. Aborting this package."
                break
              fi
              
              # b. Deployment using FlashPipe
              flashpipe sync \
                --tmn-host "$TMN_HOST" \
                --oauth-host "$OAUTH_HOST" \
                --oauth-clientid "$CLIENT_ID" \
                --oauth-clientsecret "$CLIENT_SECRET" \
                --package-id "$PKG_ID" \
                --dir-artifacts "$PACKAGE_DIR" \
                --sync-package-details \
                --target "tenant"
                
              if [ $? -ne 0 ]; then
                  echo "::error::Deployment FAILED for hash $COMMIT_HASH on package $PKG_ID. Stopping history restoration for this package."
                  EXIT_CODE=1
                  break
              fi
              
              # c. Clean up the checkout before the next loop iteration
              # Revert the directory back to the main branch's HEAD state
              git checkout HEAD -- "$PACKAGE_DIR"
              echo "   ✅ SUCCESS: Content deployed as next CPI version."
            done
            
            echo "COMPLETED HISTORY RESTORATION FOR PACKAGE: $PKG_ID"
          done
          
          exit $EXIT_CODE
